<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìš´ë™ í˜ì´ì§€</title>
    <link href="/css/exercise/exerciseMain.css" rel="stylesheet">
    <!-- ì œì´ì¿¼ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script th:if="${msg}">
      alert("[[${msg}]]");
    </script>
    <script>
      $(document).ready(function () {
      // ë²„íŠ¼ í´ë¦­ í•˜ë©´ íŒì—… ë³´ì—¬ì¤Œ
      $('.target-write-btn').click(function () {
        console.log("target-write-btn ë“¤ì–´ì˜´");
        $('.target-popup').css('display', 'flex');
      });

      // ë²„íŠ¼ í´ë¦­ í•˜ë©´ íŒì—… ê°€ë¦¼
      $('.target-popup-close-btn').click(function () {
        $('.target-popup').css('display', 'none');
      });

      // .popupì„ í´ë¦­í•˜ë©´ ë‹«íˆë„ë¡ ì„¤ì •
      $(".target-popup").on("click", function () {
        $(this).hide(); // .popupì„ ìˆ¨ê¹€
      });

      // .popup-content ë‚´ë¶€ë¥¼ í´ë¦­í–ˆì„ ë•Œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
      $(".target-popup-content").on("click", function (event) {
        event.stopPropagation(); // ë¶€ëª¨(.popup)ë¡œ ì´ë²¤íŠ¸ê°€ ì „ë‹¬ë˜ì§€ ì•Šë„ë¡ ë°©ì§€
      });

      // ë²„íŠ¼ í´ë¦­ í•˜ë©´ íŒì—… ë³´ì—¬ì¤Œ
      $('.exercise-type-popup-btn').click(function () {
        $('.exercise-type-popup').css('display', 'flex');
      });

      // ë²„íŠ¼ í´ë¦­ í•˜ë©´ íŒì—… ê°€ë¦¼
      $('.exercise-type-popup-close-btn').click(function () {
        $('.exercise-type-popup').css('display', 'none');
      });

      // .popupì„ í´ë¦­í•˜ë©´ ë‹«íˆë„ë¡ ì„¤ì •
      $(".exercise-type-popup").on("click", function () {
        $(this).hide(); // .popupì„ ìˆ¨ê¹€
      });

      // .popup-content ë‚´ë¶€ë¥¼ í´ë¦­í–ˆì„ ë•Œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
      $(".exercise-type-popup-content").on("click", function (event) {
        event.stopPropagation(); // ë¶€ëª¨(.popup)ë¡œ ì´ë²¤íŠ¸ê°€ ì „ë‹¬ë˜ì§€ ì•Šë„ë¡ ë°©ì§€
      });
    });
    </script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ko.js"></script>
    <script th:inline="javascript">
      let calendar;
      let calendarEl;

      document.addEventListener('DOMContentLoaded', function() {
        calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridWeek', // ì£¼ ë‹¨ìœ„ë¡œ í‘œì‹œ
          height: 'auto',
          dayMaxEvents: 3,
          contentHeight: 'auto', // ì¼ì •ì´ ë§ì•„ë„ ë†’ì´ ìœ ì§€
          headerToolbar: {
            left: 'prev',
            center: 'title',
            right: 'next'
          },
          views: {
            dayGridMonth: {
              titleFormat: { year: 'numeric', month: '2-digit' } // YYYY.MM í˜•ì‹
            },
            dayGridWeek: {
              titleFormat: { year: 'numeric', month: '2-digit'} // YYYY.MM í˜•ì‹
            }
          },
          dayCellDidMount: function(info) {
            let cell = info.el;
            let existingDateEl = cell.querySelector('.fc-daygrid-day-number');

            if (existingDateEl) {
              existingDateEl.remove(); // ê¸°ì¡´ ë‚ ì§œ ì‚­ì œ
            }

            let dateEl = document.createElement('div');
            dateEl.classList.add('fc-daygrid-day-number');
            dateEl.innerText = info.date.getDate();

            dateEl.style.position = 'absolute';
            dateEl.style.top = '8px';
            dateEl.style.right = '8px';
            dateEl.style.fontSize = '14px';
            dateEl.style.fontWeight = 'bold';
            dateEl.style.zIndex = '10';

            // ìš”ì¼ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½ (ì¼ìš”ì¼: ë¹¨ê°•, í† ìš”ì¼: íŒŒë‘)
            let dayOfWeek = info.date.getDay(); // 0: ì¼ìš”ì¼, 6: í† ìš”ì¼
            if (dayOfWeek === 0) {
              dateEl.style.color = 'red';
            } else if (dayOfWeek === 6) {
              dateEl.style.color = 'blue';
            } else {
              dateEl.style.color = 'black';
            }

            cell.appendChild(dateEl);
          },
          dayHeaderFormat: { weekday: 'short' }, // ìš”ì¼ë§Œ í‘œì‹œ
          datesSet: function(info) {
            // FullCalendarê°€ ê³„ì‚°í•œ íƒ€ì´í‹€ ë¬¸ìì—´
            const rawTitle = info.view.title; // ì˜ˆ: "2025/02"

            // ì—¬ê¸°ì„œ ì§ì ‘ split ì²˜ë¦¬
            const parts = rawTitle.split('/');
            let year = 'Unknown Year';
            let month = 'Unknown Month';

            if (parts.length === 2) {
              year = parts[1].trim();
              month = parts[0].trim();
            }

            // ê·¸ë‹¤ìŒ DOM ì¡°ì‘ (titleEl ì œê±°/ì¶”ê°€ ë“±)
            const titleEl = document.querySelector('.fc-toolbar-title');
            if (titleEl) {
                        titleEl.innerHTML = `
                            <div class="calendar-title">
                              <div class="calendar-year">${year}</div>
                              <div class="calendar-month">${month}</div>
                            </div>
                          `;
            }
            setTimeout(() => {
              document.querySelectorAll('.fc-daygrid-day').forEach(cell => {
                let existingDateEl = cell.querySelector('.fc-daygrid-day-number');

                // ê¸°ì¡´ ë‚ ì§œ ìš”ì†Œê°€ ìˆìœ¼ë©´ ì‚­ì œ
                if (existingDateEl) {
                  existingDateEl.remove();
                }

                // ìƒˆë¡œìš´ ë‚ ì§œ ìš”ì†Œ ìƒì„±
                let dateEl = document.createElement('div');
                dateEl.classList.add('fc-daygrid-day-number');

                // ë‚ ì§œ ê³„ì‚°
                let date = new Date(cell.getAttribute('data-date')).getDate();
                dateEl.innerText = date;

                // ë‚ ì§œ ìŠ¤íƒ€ì¼ ì ìš©
                dateEl.style.position = 'absolute';
                dateEl.style.top = '8px';
                dateEl.style.right = '8px';
                dateEl.style.fontSize = '14px';
                dateEl.style.color = 'black';
                dateEl.style.fontWeight = 'bold';
                dateEl.style.zIndex = '10';

                // ë‚ ì§œ ìš”ì†Œ ì¶”ê°€
                cell.appendChild(dateEl);
              });
            }, 50);
          },
          events: '/exercise/getExerciseEvents',
          eventClick: function (info) {
            showEventPopup(info.event);
            eventSave(info.event);
          }
        });

        // ğŸ“Œ ì„œë²„ì—ì„œ ìš´ë™ ê¸°ë¡ ê°€ì ¸ì™€ì„œ ìº˜ë¦°ë”ì— ì¶”ê°€
        fetch('/exercise/getExerciseEvents')
          .then(response => response.json())
          .then(exerciseList => {
            exerciseList.forEach(exercise => {
              calendar.addEvent({
                title: `${exercise.exerciseName}`,
                start: exercise.regDate,
                extendedProps: { // âœ… ì¶”ê°€ ë°ì´í„° ì €ì¥
                  hour: exercise.hour, // ìš´ë™ ì‹œê°„
                  minute: exercise.minute, // ìš´ë™ ì‹œê°„
                  kcal: exercise.kcal, // ì†Œëª¨ ì¹¼ë¡œë¦¬
                  exercisePk: exercise.exercisePk
                },
                color: "#9EDE9EFF"
              });
            });
          })
          .catch(error => console.error("Error loading exercises:", error));

        calendar.render();
      });

      // ìš´ë™ ê¸°ë¡í•˜ê¸°
      document.addEventListener("DOMContentLoaded", function () {
        const userPk = [[${userPk}]]; // Modelì—ì„œ ê°€ì ¸ì˜¨ userPk ê°’
        const exercisePopup = document.querySelector(".exercise-type-popup");
        const exerciseTypeBtn = document.querySelector(".exercise-type-popup-btn");
        const exerciseTypeSaveBtn = document.querySelector(".exercise-type-save-btn");
        const exerciseTypeDisplay = document.querySelector("#selected-exercise");
        const exerciseTimeHour = document.querySelector("#hour");
        const exerciseTimeMinute = document.querySelector("#minute");
        const saveExerciseBtn = document.querySelector(".exercise-save");
        const exerciseSearchInput = document.querySelector("#exercise-search");
        const exerciseResetBtn = document.querySelector("#reset-exercise-btn");
        let selectedExercise = "";
        let selectedMet = 0; // MET ì €ì¥ ë³€ìˆ˜
        let exerciseList = []; // ìš´ë™ ë¦¬ìŠ¤íŠ¸ ì €ì¥

        // âœ… ì˜¤ëŠ˜ ë‚ ì§œì— ìš´ë™ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
        fetch(`/exercise/has-today-exercise?userPk=${userPk}`)
                .then(response => response.json())
                .then(hasData => {
                  if (hasData && saveExerciseBtn) {
                    // disableSaveExerciseButton();
                  }
                })
                .catch(error => console.error("Error checking today's exercise data:", error));

        // ğŸ“Œ ìš´ë™ëª… ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (API í˜¸ì¶œ)
        fetch('/exercise/apiList')
                .then(response => response.json())
                .then(data => {
                  exerciseList = data; // ì „ì²´ ë¦¬ìŠ¤íŠ¸ ì €ì¥
                  renderExerciseList(""); // ì´ˆê¸° ì „ì²´ ëª©ë¡ í‘œì‹œ
                })
                .catch(error => console.error("Error fetching exercises:", error));

        // ğŸ“Œ ìš´ë™ ëª©ë¡ì„ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderExerciseList(searchTerm) {
          const exerciseContainer = document.querySelector(".exercise-type-popup__body");
          exerciseContainer.innerHTML = "";

          // ê²€ìƒ‰ì–´ í•„í„°ë§
          const filteredExercises = exerciseList.filter(exercise =>
            exercise.exerciseName.includes(searchTerm) // ê²€ìƒ‰ì–´ê°€ í¬í•¨ëœ ìš´ë™ë§Œ í•„í„°ë§
          );

          // í•„í„°ë§ëœ ìš´ë™ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
          filteredExercises.forEach(exercise => {
            const exerciseDiv = document.createElement("div");
            exerciseDiv.classList.add("exercise-item");
            exerciseDiv.innerHTML =
                    `<div>${exercise.exerciseName}</div>
                     <input type="hidden" value="${exercise.metValue}">`;

            // í´ë¦­ ì‹œ ì„ íƒëœ ìš´ë™ ì €ì¥
            exerciseDiv.dataset.exerciseName = exercise.exerciseName;
            exerciseDiv.dataset.metValue = exercise.metValue;

            exerciseContainer.appendChild(exerciseDiv);
          });
        }

        // ğŸ“Œ ìš´ë™ ê²€ìƒ‰ ê¸°ëŠ¥ (ì…ë ¥í•  ë•Œë§ˆë‹¤ í•„í„°ë§)
        exerciseSearchInput.addEventListener("input", function () {
          renderExerciseList(this.value.trim());
        });

        // ğŸ“Œ ìš´ë™ í´ë¦­ ì‹œ ì„ íƒ
        document.querySelector(".exercise-type-popup__body").addEventListener("click", function (event) {
          const selectedDiv = event.target.closest(".exercise-item");
          if (!selectedDiv) return;

          selectedExercise = selectedDiv.dataset.exerciseName; // ì„ íƒí•œ ìš´ë™ëª…
          selectedMet = selectedDiv.dataset.metValue; // ì„ íƒí•œ MET ê°’
          document.querySelectorAll(".exercise-item").forEach(div => div.classList.remove("selected"));
          selectedDiv.classList.add("selected");
        });

        // ğŸ“Œ ìš´ë™ ì„ íƒ í›„ ì €ì¥
        exerciseTypeSaveBtn.addEventListener("click", function () {
          if (!selectedExercise) {
            alert("ìš´ë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
            return;
          }

          exerciseTypeBtn.style.display = "none";
          exerciseTypeDisplay.style.display = "block";
          exerciseTypeDisplay.textContent = selectedExercise;

          // ì„ íƒí•œ ê°’ hidden inputìœ¼ë¡œ ì €ì¥ (ì„œë²„ ì „ì†¡ìš©)**
          document.querySelector("#selected-exercise-name").value = selectedExercise;
          document.querySelector("#selected-exercise-met").value = selectedMet;

          exercisePopup.style.display = "none";

          // âœ… ìš´ë™ ì¢…ëª©ì´ ì„ íƒë˜ì—ˆìœ¼ë¯€ë¡œ ë¦¬ì…‹ ë²„íŠ¼ í‘œì‹œ
          exerciseResetBtn.style.display = "flex";
        });

        // ğŸ“Œ ìš´ë™ ì„ íƒ ì´ˆê¸°í™”(ì‚­ì œ) ë²„íŠ¼
        document.getElementById("reset-exercise-btn").addEventListener("click", function () {

          // ì„ íƒí–ˆë˜ ê°’ ì´ˆê¸°í™”
          selectedExercise = null;
          selectedMet = null;

          // ëª¨ë“  í•­ëª©ì˜ selected í´ë˜ìŠ¤ ì œê±°
          document.querySelectorAll(".exercise-item").forEach(div => div.classList.remove("selected"));

          // í™”ë©´ì— í‘œì‹œ ì¤‘ì¸ ìš´ë™ëª…ë„ ì œê±°
          exerciseTypeBtn.style.display = "block";
          exerciseTypeDisplay.style.display = "none";
          exerciseTypeDisplay.textContent = "";

          // ì„ íƒí•œ ê°’ hidden inputìœ¼ë¡œ ì €ì¥ (ì„œë²„ ì „ì†¡ìš©)**
          document.querySelector("#selected-exercise-name").value = selectedExercise;
          document.querySelector("#selected-exercise-met").value = selectedMet;

          // âœ… ë‹¤ì‹œ ë¦¬ì…‹ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          exerciseResetBtn.style.display = "none";

          console.log("ìš´ë™ ì¢…ëª© ì„ íƒì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });

        // ìš´ë™ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ë°ì´í„° ì „ì†¡
        saveExerciseBtn.addEventListener("click", function (event) {
          event.preventDefault();

          if (!selectedExercise) {
            alert("ìš´ë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
            return;
          }

          let hour = parseInt(exerciseTimeHour.value, 10);
          let minute = parseInt(exerciseTimeMinute.value, 10);
          let today = new Date().toLocaleDateString("ko-KR").replace(/. /g, "-").replace(".", "");

          let exerciseData = {
            exerciseName: selectedExercise,
            metValue: selectedMet,
            hour: hour,
            minute: minute,
            regDate: today
          };

          fetch('/exercise/saveExercise', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(exerciseData)
          })
          .then(response => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then(result => {
            alert(result.message); // ì˜¬ë°”ë¥¸ JSON ì‘ë‹µ ì²˜ë¦¬

            // âœ… ì£¼ê°„ ëª©í‘œ ë‹¬ì„± ìˆ˜ ê°€ì ¸ì˜¤ê¸°
            fetch(`/target/count?userPk=${userPk}`)
                    .then(response => response.json())
                    .then(count => {
                      document.getElementById("weekly-goal-count").textContent = `${count}íšŒ`;
                    })
                    .catch(error => console.error("Error fetching weekly goal count:", error));

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            exerciseTypeDisplay.textContent = "";
            exerciseTypeDisplay.style.display = "none";
            exerciseTypeBtn.style.display = "inline-block";
            exerciseTimeHour.value = "00";
            exerciseTimeMinute.value = "00";

            // âœ… ìŠ¤í¬ë¡¤ ì´ë™ í”Œë˜ê·¸ ì €ì¥ (localStorage ì‚¬ìš©)
            localStorage.setItem("scrollToCalendar", "true");

            // âœ… 100ms í›„ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰
            setTimeout(() => {
              window.location.reload();
            }, 100);
          })
          .catch(error => console.error("Error saving exercise:", error));
        });
      });

      window.onload = function () {
        // âœ… ìƒˆë¡œê³ ì¹¨ í›„ ì´ë™ í”Œë˜ê·¸ í™•ì¸
        if (localStorage.getItem("scrollToCalendar") === "true") {
          localStorage.removeItem("scrollToCalendar"); // âœ… í”Œë˜ê·¸ ì‚­ì œ (í•œ ë²ˆë§Œ ì‹¤í–‰)

          setTimeout(() => {
            var calendarEl = document.getElementById('calendar');
            if (calendarEl) {
              console.log("ğŸ“Œ ìº˜ë¦°ë”ë¡œ ìŠ¤í¬ë¡¤ ì´ë™ ì‹¤í–‰"); // ë””ë²„ê¹… ë¡œê·¸
              calendarEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); // âœ… ìŠ¤í¬ë¡¤ ì´ë™
              calendarEl.focus(); // âœ… í¬ì»¤ìŠ¤ ì„¤ì • (ì„ íƒ ì‚¬í•­)
            }
          }, 500); // âœ… 1ì´ˆ í›„ ì‹¤í–‰ (ë Œë”ë§ ì™„ë£Œ í›„ ì‹¤í–‰ë˜ë„ë¡ ë”œë ˆì´ ì¶”ê°€)
        }
      };

      // âœ… ê¸°ë¡í•œ ìš´ë™ íŒì—… í‘œì‹œ í•¨ìˆ˜
      function showEventPopup(event) {
        const modal = document.getElementById("event-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalContent = document.getElementById("modal-content");

        /// âœ… ì„ íƒí•œ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (YYYY-MM-DD í˜•ì‹)
        const eventDate = event.start.toISOString().split('T')[0];

        // âœ… ì¶”ê°€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const { minute, hour, kcal } = event.extendedProps;

        modalTitle.innerText = `${eventDate}`;

        // âœ… ìš´ë™ ìƒì„¸ ì •ë³´ í‘œì‹œ
        modalContent.innerHTML = `
          <p><strong>ìš´ë™ëª…:</strong> <span>${event.title}</span></p>
          <p><strong>ìš´ë™ ì‹œê°„:</strong> <span>${hour}ì‹œê°„ ${minute}ë¶„</span></p>
          <p><strong>ì†Œëª¨ ì¹¼ë¡œë¦¬:</strong> <span>${kcal} kcal</span></p>
        `;


        modal.style.display = "flex"; // ëª¨ë‹¬ ë„ìš°ê¸°
      }

      // âœ… ìš´ë™ ê¸°ë¡ ì‚­ì œí•˜ê¸°
      function eventSave(event) {
        const exercisePk = event.extendedProps.exercisePk;
        const userPk = [[${userPk}]]; // Modelì—ì„œ ê°€ì ¸ì˜¨ userPk ê°’
        if (exercisePk === 0) {
          console.error("Invalid exercise ID");
          return;
        }

        $(".exercise-delete-btn").off("click").on("click", function () {
          const isConfirmed = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
          if (!isConfirmed) {
            console.log("ì‚­ì œ ì·¨ì†Œë¨");
            return;
          }

          // ìš´ë™ ê¸°ë¡ ì‚­ì œ ìš”ì²­
          fetch(`/exercise/deleteExercise?exercisePk=${exercisePk}`)
                  .then(response => response.json())
                  .then(result => {

                    // âœ… ë¡œë”© ëª¨ë‹¬ ë¬¸êµ¬ ë³€ê²½ (ìš´ë™ ì‚­ì œ ì „ìš© ë©”ì‹œì§€)
                    $("#loading-screen p").text("ìš´ë™ ê¸°ë¡ ì‚­ì œ ì¤‘ì…ë‹ˆë‹¤...");
                    $("#loading-screen").fadeIn();

                    setTimeout(() => {
                      fetch(`/target/current-week?userPk=${userPk}`)
                              .then(response => response.json())
                              .then(data => {
                                if (!data) return;

                                // âœ… 4. ëª©í‘œ ë°ì´í„° UI ì—…ë°ì´íŠ¸
                                document.querySelector(".target-1 .current").textContent = `${data.exerciseCount.toLocaleString()}íšŒ`;
                                document.querySelector(".target-1 .goal").textContent = `${data.exerciseTarget.toLocaleString()}íšŒ`;
                                document.querySelector(".target-2 .current").textContent = `${data.valueCount.toLocaleString()}íšŒ`;
                                document.querySelector(".target-2 .goal").textContent = `${data.valueTarget.toLocaleString()}íšŒ`;
                                document.querySelector(".target-3 .current").textContent = `${data.kcalSum.toLocaleString()}kcal`;
                                document.querySelector(".target-3 .goal").textContent = `${data.kcalTarget.toLocaleString()}kcal`;

                                // âœ… 5. ì§„í–‰ ë°” ì—…ë°ì´íŠ¸
                                updateProgress(".target-1 .target-progress", data.exerciseCount, data.exerciseTarget);
                                updateProgress(".target-2 .target-progress", data.valueCount, data.valueTarget);
                                updateProgress(".target-3 .target-progress", data.kcalSum, data.kcalTarget);

                                // âœ… 6. ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ í™•ì¸ ë° SUCCESS ë„ì¥ í‘œì‹œ
                                toggleSuccessStamp(".target-1 .success-stamp", data.exerciseCount, data.exerciseTarget);
                                toggleSuccessStamp(".target-2 .success-stamp", data.valueCount, data.valueTarget);
                                toggleSuccessStamp(".target-3 .success-stamp", data.kcalSum, data.kcalTarget);

                                // âœ… 7. ëª©í‘œê°€ ë‹¬ì„±ë˜ì§€ ì•Šì€ ê²½ìš° target_count ê°ì†Œ
                                checkAllGoalsCompleted(userPk, data);
                              })
                              .catch(error => console.error("Error loading target data:", error));

                      $("#loading-screen").fadeOut(); // "ì €ì¥ ì¤‘" ë©”ì‹œì§€ ë° ìŠ¤í”¼ë„ˆ ì œê±°
                      // âœ… ëª¨ë‹¬ ë¬¸êµ¬ë¥¼ ì›ë˜ëŒ€ë¡œ ë³µì› (í•„ìš”í•˜ë‹¤ë©´)
                      $("#loading-screen p").text("ì´ë²ˆ ì£¼ì— ê¸°ë¡í•œ ë‚´ìš©ì„ ë°˜ì˜ ì¤‘ ì…ë‹ˆë‹¤...");

                      alert(result.message); // âœ… ì‚­ì œ ì™„ë£Œ ë©”ì‹œì§€ ì¶œë ¥
                      window.location.reload();
                    }, 2000); // ì„œë²„ì—ì„œ ì‚­ì œëœ ë°ì´í„°ë¥¼ ë°˜ì˜í•  ì‹œê°„ì„ ì¤Œ
                  })
                  .catch(error => console.error("Delete failed:", error));
        });
      }


        // âœ… ëª¨ë‹¬ ë‹«ê¸° ê¸°ëŠ¥
      function closeModal() {
        document.getElementById("event-modal").style.display = "none";
      }
    </script>
    <script th:inline="javascript">
      // ê·¸ë˜í”„ ì €ì¥
      document.addEventListener("DOMContentLoaded", function () {
        const userPk = [[${userPk}]]; // Modelì—ì„œ ê°€ì ¸ì˜¨ userPk ê°’
        const saveButton = document.querySelector(".save-button"); // ì €ì¥ ë²„íŠ¼
        const saveForm = document.getElementById("graph-form");// âœ… í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€

        let hasTodayData = false; // ì˜¤ëŠ˜ ë°ì´í„°ê°€ ìˆëŠ”ì§€ ì—¬ë¶€ í™•ì¸ ë³€ìˆ˜

        // âœ… ì˜¤ëŠ˜ ë‚ ì§œì— ê·¸ë˜í”„ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
        fetch(`/graph/has-today-graph?userPk=${userPk}`)
                .then(response => response.json())
                .then(hasData => {
                  console.log("Has Today Graph Data:", hasData); // ë””ë²„ê¹… ë¡œê·¸
                  hasTodayData = hasData;
                })
                .catch(error => console.error("Error checking today's graph data:", error));

        // âœ… ê·¸ë˜í”„ ì €ì¥ í•¨ìˆ˜
        function graphSaveCheck(event) {
          event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€

          const bloodSugarInput = document.getElementById("blood_sugar");
          const bloodPressInput = document.getElementById("blood_press");
          const weightInput = document.getElementById("weight");

          const bloodSugar = bloodSugarInput.value.trim();
          const bloodPress = bloodPressInput.value.trim();
          const weight = weightInput.value.trim();

          if (!bloodSugar && !bloodPress && !weight) {
            alert("ìˆ˜ì¹˜ë¥¼ í•œ ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (!bloodSugar) bloodSugarInput.focus();
            return;
          }

          const data = {
            userPk: userPk,
            bloodSugar: bloodSugar || null,
            bloodPress: bloodPress || null,
            weight: weight || null
          };

          // ì €ì¥í•  URL ê²°ì • (ì˜¤ëŠ˜ ë‚ ì§œì— ê¸°ì¡´ ìˆ˜ì¹˜ ë°ì´í„°ê°€ ìˆìœ¼ë©´ update, ì—†ìœ¼ë©´ save)
          const url = hasTodayData ? '/graph/updateGraph' : '/graph/saveGraph'

          fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(response => {
            console.log("ğŸ“¡ ì„œë²„ ì‘ë‹µ ì½”ë“œ:", response.status);
            return response;
          })
          .then(result => {
            alert(hasTodayData ? "ì˜¤ëŠ˜ì˜ ìˆ˜ì¹˜ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤." : "ì˜¤ëŠ˜ì˜ ìˆ˜ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");

            // âœ… ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            bloodSugarInput.value = "";
            bloodPressInput.value = "";
            weightInput.value = "";

            // âœ… í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.location.reload();
          })
          .catch(error => console.error('Error:', error));
        }

        if (saveForm) {
          saveForm.addEventListener("submit", graphSaveCheck);
        }
      });

      // ëª©í‘œ ì„¤ì •
      document.addEventListener("DOMContentLoaded", function () {
        const userPk = [[${userPk}]]; // Modelì—ì„œ ê°€ì ¸ì˜¨ userPk ê°’
        const targetWriteBtn = document.querySelector(".target-write-btn");

        // âœ… ìš´ë™ ê¸°ë¡ íšŸìˆ˜ ê°€ì ¸ì˜¤ê¸°
        fetch(`/exercise/count?userPk=${userPk}`)
                .then(response => response.json())
                .then(count => {
                  document.getElementById("exercise-count").textContent = `${count}íšŒ`;
                })
                .catch(error => console.error("Error fetching exercise count:", error));

        // âœ… ì£¼ê°„ ëª©í‘œ ë‹¬ì„± ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        fetch(`/target/count?userPk=${userPk}`)
                .then(response => response.json())
                .then(count => {
                  document.getElementById("weekly-goal-count").textContent = `${count}íšŒ`;
                })
                .catch(error => console.error("Error fetching weekly goal count:", error));

        // âœ… ì´ë²ˆ ì£¼ ëª©í‘œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fetch(`/target/current-week?userPk=${userPk}`)
                .then(response => response.json())
                .then(data => {
                  if (!data) return;

                  if (data) {
                    targetWriteBtn.disabled = true;
                  }

                  // âœ… ëª©í‘œ ì •ë³´ ì—…ë°ì´íŠ¸
                  document.querySelector(".target-1 .current").textContent = `${data.exerciseCount.toLocaleString()}íšŒ`;
                  document.querySelector(".target-1 .goal").textContent = `${data.exerciseTarget.toLocaleString()}íšŒ`;
                  document.querySelector(".target-2 .current").textContent = `${data.valueCount.toLocaleString()}íšŒ`;
                  document.querySelector(".target-2 .goal").textContent = `${data.valueTarget.toLocaleString()}íšŒ`;
                  document.querySelector(".target-3 .current").textContent = `${data.kcalSum.toLocaleString()}kcal`;
                  document.querySelector(".target-3 .goal").textContent = `${data.kcalTarget.toLocaleString()}kcal`;

                  // âœ… ì§„í–‰ ë°” ì—…ë°ì´íŠ¸
                  updateProgress(".target-1 .target-progress", data.exerciseCount, data.exerciseTarget);
                  updateProgress(".target-2 .target-progress", data.valueCount, data.valueTarget);
                  updateProgress(".target-3 .target-progress", data.kcalSum, data.kcalTarget);

                  // âœ… ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ í™•ì¸ ë° SUCCESS ë„ì¥ í‘œì‹œ
                  toggleSuccessStamp(".target-1 .success-stamp", data.exerciseCount, data.exerciseTarget);
                  toggleSuccessStamp(".target-2 .success-stamp", data.valueCount, data.valueTarget);
                  toggleSuccessStamp(".target-3 .success-stamp", data.kcalSum, data.kcalTarget);

                  // âœ… ëª¨ë“  ëª©í‘œê°€ ë‹¬ì„±ë˜ì—ˆëŠ”ì§€ ì²´í¬ í›„ target_count ì¦ê°€
                  checkAllGoalsCompleted(userPk, data);
                })
                .catch(error => console.error("Error loading target data:", error));

        // âœ… ëª©í‘œ ì €ì¥ ì²´í¬ (ëª©í‘œ ì…ë ¥ í›„ ì„œë²„ë¡œ ì „ì†¡)
        function targetSaveCheck(event) {
          event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€

          const exerciseTargetInput = document.querySelector("[name='exercise_target']");
          const valueTargetInput = document.querySelector("[name='value_target']");
          const kcalTargetInput = document.querySelector("[name='kcal_target']");

          const exerciseTarget = exerciseTargetInput.value.trim();
          const valueTarget = valueTargetInput.value.trim();
          const kcalTarget = kcalTargetInput.value.trim();

          // âœ… ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ì…ë ¥ê°’ì´ í•„ìš”í•¨
          if (!exerciseTarget && !valueTarget && !kcalTarget) {
            alert("ëª©í‘œë¥¼ í•œ ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            // ë¹„ì–´ ìˆëŠ” ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ ë§ì¶”ê¸°
            if (!exerciseTarget) {
              exerciseTargetInput.focus();
            } else if (!valueTarget) {
              valueTargetInput.focus();
            } else {
              kcalTargetInput.focus();
            }
            return;
          }

          // âœ… ëª©í‘œ ë°ì´í„° ê°ì²´ ìƒì„±
          const data = {
            userPk: userPk,
            exerciseTarget: exerciseTarget || null,
            valueTarget: valueTarget || null,
            kcalTarget: kcalTarget || null
          };

          // âœ… ì„œë²„ë¡œ ëª©í‘œ ì €ì¥ ìš”ì²­
          fetch('/target/saveTarget', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          })
          .then(response => response.json())
          .then(result => {

            $("#loading-screen").fadeIn();

            // âœ… 2ì´ˆ í›„ "ì €ì¥ ì¤‘" ë©”ì‹œì§€ ìˆ¨ê¸°ê³  alert ë„ìš°ê¸°
            setTimeout(() => {
              $("#loading-screen").fadeOut(); // "ì €ì¥ ì¤‘" ë©”ì‹œì§€ ë° ìŠ¤í”¼ë„ˆ ì œê±°
              alert(result.message); // âœ… alert ë„ì›€

              // âœ… ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
              exerciseTargetInput.value = "";
              valueTargetInput.value = "";
              kcalTargetInput.value = "";

              window.location.reload();
            }, 5000); // "ì €ì¥ ì¤‘" ë©”ì‹œì§€ëŠ” 2ì´ˆê°„ ìœ ì§€ í›„ alert ì°½ ë„ìš°ê¸°
          })
          .catch(error => console.error('Error:', error));
        }

        // âœ… í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const targetForm = document.getElementById("target-form");
        if (targetForm) {
          targetForm.addEventListener("submit", targetSaveCheck);
        }
      });

      // âœ… ëª©í‘œ ì§„í–‰ ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateProgress(selector, current, goal) {
        const progressBar = document.querySelector(selector);
        if (!progressBar) return;

        const percentage = goal === 0 ? 0 : (current / goal) * 100;
        progressBar.style.width = `${percentage}%`;
      }

      // âœ… ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ í™•ì¸ ë° SUCCESS ë„ì¥ í‘œì‹œ í•¨ìˆ˜
      function toggleSuccessStamp(selector, current, target) {
        const stamp = document.querySelector(selector);
        if (stamp) {
          if (target === 0) {
            stamp.style.display = "none"; // ëª©í‘œ ê°’ì´ 0ì´ë©´ ë„ì¥ ìˆ¨ê¹€
          } else {
            stamp.style.display = current >= target ? "flex" : "none"; // ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ì— ë”°ë¼ í‘œì‹œ
          }
        }
      }

      // âœ… ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ë¥¼ ì²´í¬í•˜ê³  `target_count` ì—…ë°ì´íŠ¸
      function checkAllGoalsCompleted(userPk, data) {
        const exerciseCompleted = data.exerciseCount >= data.exerciseTarget && data.exerciseTarget > 0;
        const valueCompleted = data.valueCount >= data.valueTarget && data.valueTarget > 0;
        const kcalCompleted = data.kcalSum >= data.kcalTarget && data.kcalTarget > 0;

        const allGoalsCompleted = exerciseCompleted && valueCompleted && kcalCompleted;

        // âœ… í˜„ì¬ ëª©í‘œ ë‹¬ì„± ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸° (ë””ë²„ê¹… ì¶”ê°€)
        fetch(`/target/count?userPk=${userPk}`)
                .then(response => response.json())
                .then(count => {
                  const currentTargetCount = count;
                  // console.log("í˜„ì¬ target_count:", currentTargetCount);
                  // console.log("í˜„ì¬ ëª©í‘œ ë‹¬ì„± ìƒíƒœ:", allGoalsCompleted);

                  if (allGoalsCompleted && currentTargetCount === 0) {
                    // console.log("âœ… ëª©í‘œë¥¼ ì²˜ìŒ ë‹¬ì„±í–ˆìœ¼ë¯€ë¡œ ì¦ê°€!");
                    updateTargetCount(userPk, "increase");
                  } else if (!allGoalsCompleted && currentTargetCount > 0) {
                    // console.log("â›”ï¸ ëª©í‘œê°€ ë‹¬ì„±ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ê°ì†Œ!");
                    updateTargetCount(userPk, "decrease");
                  } else {
                    // console.log("ğŸ”„ ëª©í‘œ ìƒíƒœê°€ ë³€í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì—…ë°ì´íŠ¸ ì—†ìŒ.");
                  }
                })
                .catch(error => console.error("Error fetching weekly goal count:", error));
      }

      // âœ… ëª©í‘œ ë‹¬ì„± ì‹œ user_detail í…Œì´ë¸”ì˜ target_count +1 ì—…ë°ì´íŠ¸ (ì´ë²ˆ ì£¼ì— í•œ ë²ˆë§Œ)
      function updateTargetCount(userPk, action) {
        console.log(`ğŸš€ updateTargetCount ì‹¤í–‰ë¨! Action: ${action}`); // ë””ë²„ê¹… ì¶”ê°€

        fetch(`/target/update-target-count?userPk=${userPk}&action=${action}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userPk }),
        })
                .then(response => response.json())
                .then(result => {
                  console.log(`âœ… Target count ${action} ì„±ê³µ:`, result);
                  // âœ… ì£¼ê°„ ëª©í‘œ ë‹¬ì„± ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                  fetch(`/target/count?userPk=${userPk}`)
                          .then(response => response.json())
                          .then(count => {
                            document.getElementById("weekly-goal-count").textContent = `${count}íšŒ`;
                            console.log(`ğŸ¯ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${count}íšŒ`);
                          })
                          .catch(error => console.error("Error fetching weekly goal count:", error));
                })
                .catch(error => console.error(`âŒ Target count ${action} ì‹¤íŒ¨:`, error));
      }

    </script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<!-- ëª©í‘œ ì €ì¥ ë¡œë”© ëª¨ë‹¬ -->
<div id="loading-screen" style="display: none;">
    <svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
      <circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
    </svg>
    <p>ì´ë²ˆ ì£¼ì— ê¸°ë¡í•œ ë‚´ìš©ì„ ë°˜ì˜ ì¤‘ ì…ë‹ˆë‹¤...</p>
  </div>
</div>

<!-- âœ… ì´ë²¤íŠ¸ í´ë¦­ ì‹œ í‘œì‹œí•  ëª¨ë‹¬ -->
<div id="event-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h2 id="modal-title"></h2>
    <p id="modal-content"></p>
    <button class="exercise-delete-btn">ê¸°ë¡ ì‚­ì œ</button>
  </div>
</div>

<!-- âœ… ëª©í‘œ ì‘ì„± ë²„íŠ¼ í´ë¦­ ì‹œ í‘œì‹œí•  ëª¨ë‹¬ -->
<div class="target-popup">
  <div class="target-popup-content">
    <div class="target-popup__head">
      <div>ì£¼ê°„ ëª©í‘œ ì„¤ì •í•˜ê¸° <i class="fa-solid fa-trophy"></i></div>
      <button class="target-popup-close-btn">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="target-popup__body">
      <form id="target-form">
        <ul>
          <li>
            ì´ë²ˆ ì£¼ ìš´ë™ íšŸìˆ˜ ëª©í‘œ :
            <input type="number" name="exercise_target" min="0" step="1"> íšŒ
          </li>
          <li>
            ì´ë²ˆ ì£¼ ìˆ˜ì¹˜ ê¸°ë¡ íšŸìˆ˜ ëª©í‘œ :
            <input type="number" name="value_target" min="0" step="1"> íšŒ
          </li>
          <li>
            ì´ë²ˆ ì£¼ ì†Œëª¨ ì¹¼ë¡œë¦¬ ëª©í‘œ :
            <input type="number" name="kcal_target" min="0" step="1"> kcal
          </li>
        </ul>
        <button type="submit" class="target-save-btn">ì € ì¥</button>
      </form>
    </div>
  </div>
</div>

<!-- âœ… ìš´ë™ëª… ë”ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ í‘œì‹œí•  ëª¨ë‹¬ -->
<div class="exercise-type-popup">
  <div class="exercise-type-popup-content">
    <div class="exercise-type-popup__head">
      <div>
        <input id="exercise-search" type="text" placeholder="ì¢…ëª© ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš”">
        <button class="search-btn"><i class="fa-solid fa-magnifying-glass"></i></button>
      </div>
      <button class="exercise-type-popup-close-btn">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="exercise-type-popup__body"></div>
    <div class="exercise-type-popup__foot">
      <button type="button" class="exercise-type-save-btn">ì € ì¥</button>
    </div>
  </div>
</div>

<!-- ë©”ì¸ -->
<section class="main">

  <div class="top-service">
    <div class="left-service">
      <h2>ì£¼ê°„ ëª©í‘œ <i class="fa-solid fa-trophy"></i></h2>
      <div class="target-box">
        <div class="target-1">
          <div><span>ì´ë²ˆ ì£¼ ìš´ë™ íšŸìˆ˜</span></div>
          <div>
            <div class="target-values">
              <span class="current">0íšŒ</span>
              <span class="goal">0íšŒ</span>
            </div>
            <div class="target-bar">
              <div class="target-progress"></div>
              <div class="success-stamp">SUCCESS</div> <!-- âœ… ë„ì¥ íš¨ê³¼ ì¶”ê°€ -->
            </div>
          </div>
        </div>
        <div class="target-2">
          <div><span>ì´ë²ˆ ì£¼ ìˆ˜ì¹˜ ê¸°ë¡ íšŸìˆ˜</span></div>
          <div>
            <div class="target-values">
              <span class="current">0íšŒ</span>
              <span class="goal">0íšŒ</span>
            </div>
            <div class="target-bar">
              <div class="target-progress"></div>
              <div class="success-stamp">SUCCESS</div> <!-- âœ… ë„ì¥ íš¨ê³¼ ì¶”ê°€ -->
            </div>
          </div>
        </div>
        <div class="target-3">
          <div><span>ì´ë²ˆ ì£¼ ì¹¼ë¡œë¦¬ ì†Œëª¨ëŸ‰</span></div>
          <div>
            <div class="target-values">
              <span class="current">0kcal</span>
              <span class="goal">0kcal</span>
            </div>
            <div class="target-bar">
              <div class="target-progress"></div>
              <div class="success-stamp">SUCCESS</div> <!-- âœ… ë„ì¥ íš¨ê³¼ ì¶”ê°€ -->
            </div>
          </div>
        </div>
        <button type="button" class="target-write-btn">ëª©í‘œ ì‘ì„±</button>
      </div>
    </div>
    <div class="right-service">
      <h2>ì˜¤ëŠ˜ì˜ ìˆ˜ì¹˜ ê¸°ë¡í•˜ê¸° <i class="fa-solid fa-pencil"></i></h2>
      <div class="graph">
        <form name="graph-frm" id="graph-form">
          <ul>
            <li>í˜ˆë‹¹ <input type="number" id="blood_sugar" name="blood_sugar" required> mg/dL</li>
            <li>í˜ˆì•• <input type="number" id="blood_press" name="blood_press" required> mmHg</li>
            <li>ëª¸ë¬´ê²Œ <input type="number" id="weight" name="weight" class="weight" required> kg</li>
          </ul>
          <button type="submit" class="save-button">ì € ì¥</button>
        </form>
      </div>
      <div class="cumulative-count">
        <div class="cumulative-title">
          <span>ë‚´ê°€ ë‹¬ì„±í•œ ì£¼ê°„ ëª©í‘œ ìˆ˜ <i class="fa-solid fa-medal"></i> </span>
          <span>ë‚´ê°€ ìš´ë™ ê¸°ë¡í•œ íšŸìˆ˜ <i class="fa-solid fa-medal"></i> </span>
        </div>
        <div class="cumulative-total">
          <span id="weekly-goal-count">0íšŒ</span>
          <span id="exercise-count">0íšŒ</span>
        </div>
      </div>
    </div>
  </div>

  <div class="exercise-entry">
    <form>
      <div class="exercise-type">
        ìš´ë™ ì¢…ë¥˜ :
        <span id="selected-exercise"></span>
        <i class="exercise-type-popup-btn fa-solid fa-plus"></i>
        <button id="reset-exercise-btn" type="button" style="/*display: none;*/"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <input type="hidden" id="selected-exercise-name" name="exerciseName">
      <input type="hidden" id="selected-exercise-met" name="met">

      <div class="exercise-time">
        <input type="hidden" id="selected-date" name="selectdate">
        ìš´ë™ ì‹œê°„ :
        <select id="hour" name="hour">
          <option value="00" selected>0ì‹œê°„</option>
          <option value="01">1ì‹œê°„</option>
          <option value="02">2ì‹œê°„</option>
          <option value="03">3ì‹œê°„</option>
          <option value="04">4ì‹œê°„</option>
          <option value="05">5ì‹œê°„</option>
        </select> :
        <select id="minute" name="minute">
          <option value="00" selected>0ë¶„</option>
          <option value="15">15ë¶„</option>
          <option value="30">30ë¶„</option>
          <option value="45">45ë¶„</option>
        </select>
      </div>
      <button type="submit" class="exercise-save">ì € ì¥</button>
    </form>
  </div>

  <div class="calendar" id="calendar"></div>

</section>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

</body>
</html>