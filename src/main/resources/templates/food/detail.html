<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ë‹¨ ìƒì„¸ ê¸°ë¡</title>
    <link rel="stylesheet" href="/css/food/detail.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<!-- íŒì—… -->
<div class="container">
    <div id="dietPopup" class="popup">
        <div class="icon-legend">
            <span>
                <img src="/images/ìˆ˜ì •.png" alt="ìˆ˜ì • ì•„ì´ì½˜" class="legend-icon"> : ìˆ˜ì •
            </span>
            <span>
                <img src="/images/x.png" alt="ì‚­ì œ ì•„ì´ì½˜" class="legend-icon"> : ì‚­ì œ
            </span>
        </div>
        <div class="popup-content">
            <button type="button" class="close" onclick="history.back();">&times;</button>
            <h1 id="diet-date">ì‹ë‹¨ ê¸°ë¡</h1> <!-- ë‚ ì§œ ë™ì ìœ¼ë¡œ ë³€ê²½ -->
            <div class="meal-section">

                <!-- ì•„ì¹¨ -->
                <div class="meal-time" id="breakfast">
                    <div class="meal-img">
                        <img src="/images/ì•„ì¹¨.png" alt="ì•„ì¹¨">
                    </div>
                    <div class="meal-content">
                        <ul class="meal-list">
                            <li class="meal-header">
                                <h3>ì•„ì¹¨</h3>
                                <a href="#" class="edit-icon">
                                    <img src="/images/ìˆ˜ì •.png" alt="ìˆ˜ì •">
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- ì ì‹¬ -->
                <div class="meal-time" id="lunch">
                    <div class="meal-img">
                        <img src="/images/ì ì‹¬.png" alt="ì ì‹¬">
                    </div>
                    <div class="meal-content">
                        <ul class="meal-list">
                            <li class="meal-header">
                                <h3>ì ì‹¬</h3>
                                <a href="#" class="edit-icon">
                                    <img src="/images/ìˆ˜ì •.png" alt="ìˆ˜ì •">
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- ì €ë… -->
                <div class="meal-time" id="dinner">
                    <div class="meal-img">
                        <img src="/images/ì €ë….png" alt="ì €ë…">
                    </div>
                    <div class="meal-content">
                        <ul class="meal-list">
                            <li class="meal-header">
                                <h3>ì €ë…</h3>
                                <a href="#" class="edit-icon">
                                    <img src="/images/ìˆ˜ì •.png" alt="ìˆ˜ì •">
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- ì´ ì¹¼ë¡œë¦¬ -->
                <p class="total-calories">ì´ ë‚  ë¨¹ì€ ì´ ì¹¼ë¡œë¦¬ëŠ” <span id="total-kcal">0</span> kcal ì…ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
</div>

<div class="popup-overlay">
    <div class="popup1">
        <!-- ìƒë‹¨ì— ë‹«ê¸° ë²„íŠ¼ ì¶”ê°€ -->
        <button class="popup-close-btn">x</button>
        <div class="search-section">
            <input type="text" class="search-bar" placeholder="ë¬´ìŠ¨ ìŒì‹ì„ ë“œì…¨ë‚˜ìš”?">
            <button class="search-button">ê²€ìƒ‰</button>
        </div>
        <div class="search-results">
            <table>
                <thead>
                <tr>
                    <th>ìŒì‹ëª…</th>
                    <th>ì¹¼ë¡œë¦¬</th>
                    <th>ì˜ì–‘ì •ë³´</th>
                </tr>
                </thead>
                <tbody>
                <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— ì¶”ê°€ë  ì˜ˆì • -->
                </tbody>
            </table>
        </div>
        <div class="selected-menu">
            <img src="/images/ì—°í•„.png" alt="ì—°í•„ ì•„ì´ì½˜" class="large-pencil-icon">
            <ul>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
            </ul>
        </div>
        <button class="update-button">ìˆ˜ì •í•˜ê¸°</button>
    </div>
</div>

<script>
    $(document).ready(function () {
        let selectedDate = "2025-02-06"; // ì„ íƒí•œ ë‚ ì§œ
        let userPk = 1;  // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID
        let mealTypes = ["breakfast", "lunch", "dinner"]; // ì•„ì¹¨, ì ì‹¬, ì €ë…
        let selectedMealType = ""; // í˜„ì¬ ì„ íƒëœ ì‹ì‚¬ íƒ€ì…
        let activeSlot = null; // í˜„ì¬ í™œì„±í™”ëœ ìŠ¬ë¡¯

        // âœ… ë‚ ì§œ ë³€í™˜ í•¨ìˆ˜ (YYYY-MM-DD â†’ Mì›” Dì¼)
        function formatDate(dateStr) {
            if (!dateStr) return "ë‚ ì§œ ì—†ìŒ";
            let dateParts = dateStr.split("-");
            return `${parseInt(dateParts[1])}ì›” ${parseInt(dateParts[2])}ì¼`;
        }

        // âœ… íŠ¹ì • ë‚ ì§œì˜ ì‹ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadDietRecords() {
            $.ajax({
                url: "/food/detail/data",
                type: "GET",
                data: { userPk: userPk, selectDate: selectedDate },
                success: function (response) {
                    $(".meal-list").each(function () {
                        $(this).find(".meal-menu").remove(); // ê¸°ì¡´ ìŒì‹ ëª©ë¡ ì‚­ì œ
                    });

                    let totalCalories = 0;
                    let meals = { breakfast: [], lunch: [], dinner: [] };

                    $("#diet-date").text(`${formatDate(selectedDate)} ì‹ë‹¨ ê¸°ë¡í‘œ`);

                    response.forEach(food => {
                        let mealType = getMealType(food.foodType);
                        meals[mealType].push({
                            menu: food.menu,
                            kcal: food.kcal,
                            protein: food.protein,
                            carbohydrate: food.carbohydrate,
                            fat: food.fat,
                            foodListPk: food.foodListPk
                        });
                        totalCalories += food.kcal;
                    });

                    mealTypes.forEach(mealType => {
                        let mealSection = $("#" + mealType + " .meal-list");
                        let mealData = meals[mealType];

                        for (let i = 0; i < 5; i++) {
                            let foodItem = mealData[i]
                                ? `<li class="meal-menu" data-foodlistpk="${mealData[i].foodListPk}">
                                ${mealData[i].menu} <span>${mealData[i].kcal} kcal</span>
                                <a href="#" class="delete-icon"><img src="/images/x.png" alt="ì‚­ì œ"></a>
                            </li>`
                                : `<li class="meal-menu">
                                &nbsp; <span> &nbsp; </span>
                            </li>`;

                            mealSection.append(foodItem);
                        }
                    });

                    $("#total-kcal").text(totalCalories);
                },
                error: function (xhr, status, error) {
                    console.error("ğŸš¨ ì‹ë‹¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
                }
            });
        }

        // âœ… ì‹ì‚¬ ì½”ë“œ ë³€í™˜ (B, L, D â†’ breakfast, lunch, dinner)
        function getMealType(foodType) {
            return foodType === "B" ? "breakfast" : foodType === "L" ? "lunch" : "dinner";
        }

        // âœ… ìˆ˜ì • íŒì—… ì—´ê¸°
        $(".edit-icon").click(function () {
            $(".popup-overlay").fadeIn();
            $(".popup1").fadeIn();

            selectedMealType = $(this).closest(".meal-time").attr("id");

            $(".selected-menu li").empty();

            $.ajax({
                url: "/food/detail/data",
                type: "GET",
                data: { userPk: userPk, selectDate: selectedDate },
                success: function (response) {
                    let existingFoods = response.filter(food => getMealType(food.foodType) === selectedMealType);

                    existingFoods.forEach((food, index) => {
                        $(".selected-menu li").eq(index).html(`
                        <span>${food.menu}</span>
                        <span>${food.kcal} kcal</span>
                    `).attr("data-foodlistpk", food.foodListPk);
                    });
                }
            });
        });

        // âœ… ìŠ¬ë¡¯ í´ë¦­ ì´ë²¤íŠ¸
        $(document).on("click", ".selected-menu li", function () {
            $(".selected-menu li").removeClass("selected");
            $(this).addClass("selected");
            activeSlot = $(this);
        });

        // âœ… ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ API í˜¸ì¶œ
        $(".search-button").click(function () {
            let query = $(".search-bar").val().trim();
            if (query === "") return;

            $.ajax({
                url: "/food/search",
                type: "GET",
                data: { query: query },
                success: function (response) {
                    let tableBody = $(".search-results tbody");
                    tableBody.empty();

                    response.forEach(food => {
                        let row = `<tr data-menu="${food.menu}" data-kcal="${food.kcal}">
                        <td>${food.menu}</td>
                        <td>${food.kcal} kcal</td>
                    </tr>`;
                        tableBody.append(row);
                    });
                }
            });
        });

        // âœ… ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ ì„ íƒëœ ìŠ¬ë¡¯ì— ë°˜ì˜ (ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹)
        $(document).on("click", ".search-results tr", function () {
            if (!activeSlot) {
                alert("ë¨¼ì € ìˆ˜ì •í•  ì¹¸ì„ ì„ íƒí•˜ì„¸ìš”!");
                return;
            }

            let foodName = $(this).data("menu");
            let kcal = $(this).data("kcal");

            activeSlot.html(`
            <span>${foodName}</span>
            <span>${kcal} kcal</span>
        `);
        });

        // âœ… ìˆ˜ì • ì €ì¥ (updateMeal)
        $(".update-button").click(function () {
            let updatedFoods = [];

            $(".selected-menu li").each(function () {
                if ($(this).html().trim() !== "") {
                    let foodData = {
                        foodListPk: $(this).attr("data-foodlistpk") || null,
                        menu: $(this).find("span:nth-child(1)").text(),
                        kcal: parseInt($(this).find("span:nth-child(2)").text().replace(" kcal", ""))
                    };
                    updatedFoods.push(foodData);
                }
            });

            $.ajax({
                url: "/food/updateMeal",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ userPk, selectDate, foodType: selectedMealType.toUpperCase().charAt(0), foodList: updatedFoods }),
                success: function () {
                    alert("ì‹ë‹¨ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    $(".popup-overlay").fadeOut();
                    loadDietRecords();
                }
            });
        });

        // âœ… ê°œë³„ ìŒì‹ ì‚­ì œ
        $(document).on("click", ".delete-icon", function () {
            let foodListPk = $(this).closest(".meal-menu").data("foodlistpk");

            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            $.ajax({
                url: "/food/delete",
                type: "DELETE",
                data: { foodListPk: foodListPk },
                success: function () {
                    alert("ìŒì‹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadDietRecords();
                }
            });
        });

        // âœ… ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadDietRecords();
    });

</script>

</body>
</html>
