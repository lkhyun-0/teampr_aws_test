<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì‹ë‹¨ ë¶„ì„</title>
    <link rel="stylesheet" href="/css/food/analysis.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div class="container">
    <!-- ìƒë‹¨ íƒ­ -->
    <div class="tabs">
        <a href="/food/foodRecord" class="tab-button">ê¸°ë¡</a>
        <a href="/food/foodList" class="tab-button">ëª©ë¡</a>
        <a href="/food/analysis" class="tab-button active">ë‚´ ì‹ë‹¨ ë¶„ì„</a>
    </div>

    <div class="outer-container">

        <!-- ì£¼ê°„ ë²”ìœ„ í‘œì‹œ -->
        <div class="weekly-range">
            <p id="date-range">ì£¼ê°„ í†µê³„ ë¡œë“œ ì¤‘...</p>
        </div>

        <div class="inner-container">

            <!-- ìƒë‹¨ ì¹´ë“œ ì„¹ì…˜ -->
            <div class="top-section">
                <div class="card">
                    <p class="card-value">
                        <span id="protein-value" class="number">0</span>
                        <span class="unit">g</span>
                    </p>
                    <p class="card-title">PROTEIN</p>
                    <div class="bar">
                        <div class="bar-inner protein"></div>
                    </div>
                </div>
                <div class="card">
                    <p class="card-value">
                        <span id="carbs-value" class="number">0</span>
                        <span class="unit">g</span>
                    </p>
                    <p class="card-title">CARBOHYDRATES</p>
                    <div class="bar">
                        <div class="bar-inner carbs"></div>
                    </div>
                </div>
                <div class="card">
                    <p class="card-value">
                        <span id="fat-value" class="number">0</span>
                        <span class="unit">g</span>
                    </p>
                    <p class="card-title">FAT</p>
                    <div class="bar">
                        <div class="bar-inner fat"></div>
                    </div>
                </div>
            </div>

            <!-- í•˜ë‹¨ ì¹´ë“œ ì„¹ì…˜ -->
            <div class="bottom-section">
                <div class="card large">
                    <p class="analysis-title">ì´ë²ˆì£¼ ì´ ì¹¼ë¡œë¦¬</p>
                    <canvas id="caloriesChart"></canvas>
                </div>
                <div class="card large">
                    <p class="analysis-title">ê±´ê°•í•œ ì‹ë‹¨ ê°€ì´ë“œ</p>
                    <p id="tip-text">ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script th:inline="javascript">
    $(document).ready(function () {
        let userPk = [[${session.userPk}]];

        // í˜„ì¬ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìµœê·¼ 7ì¼ ë²”ìœ„ ê³„ì‚°
        let today = new Date();
        let startDate = new Date();
        startDate.setDate(today.getDate() - 6);

        let startStr = `${String(startDate.getMonth() + 1).padStart(2, '0')}ì›” ${String(startDate.getDate()).padStart(2, '0')}ì¼`;
        let endStr = `${String(today.getMonth() + 1).padStart(2, '0')}ì›” ${String(today.getDate()).padStart(2, '0')}ì¼`;

        $("#date-range").text(`${startStr} - ${endStr}` + " ì‹ë‹¨ ë¶„ì„");

        // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì„±ë³„ & ë‚˜ì´)
        $.ajax({
            url: "/food/getUserDetail",
            type: "GET",
            data: { userPk: userPk },
            success: function (user) {
                let gender = user.gender;
                let age = user.age;
                let standards = getNutritionStandards(gender, age);

                // ì£¼ê°„ í†µê³„ ê°€ì ¸ì˜¤ê¸°
                $.ajax({
                    url: "/food/weeklyStats",
                    type: "GET",
                    data: { userPk: userPk },
                    success: function (response) {
                        let totalProtein = 0, totalCarbs = 0, totalFat = 0, totalCalories = 0;

                        response.forEach(day => {
                            totalProtein += day.totalProtein;
                            totalCarbs += day.totalCarbohydrates;
                            totalFat += day.totalFat;
                            totalCalories += day.totalCalories;
                        });

                        $("#protein-value").text(totalProtein.toFixed(2));
                        $("#carbs-value").text(totalCarbs.toFixed(2));
                        $("#fat-value").text(totalFat.toFixed(2));

                        updateCaloriesChart(totalCalories, standards.calories);
                        updateImprovementTips(totalProtein, totalCarbs, totalFat, standards);
                    }
                });
            }
        });

        function getNutritionStandards(gender, age) {
            let standards = { protein: 0, carbs: 0, fat: 0, calories: 0 };

            if (gender === "M") {
                if (age <= 29) standards = { protein: 65 * 7, carbs: 350 * 7, fat: 70 * 7, calories: 2600 * 7 };
                else if (age <= 49) standards = { protein: 65 * 7, carbs: 340 * 7, fat: 70 * 7, calories: 2500 * 7 };
                else standards = { protein: 60 * 7, carbs: 320 * 7, fat: 65 * 7, calories: 2300 * 7 };
            } else {
                if (age <= 29) standards = { protein: 55 * 7, carbs: 300 * 7, fat: 60 * 7, calories: 2000 * 7 };
                else if (age <= 49) standards = { protein: 50 * 7, carbs: 290 * 7, fat: 55 * 7, calories: 1900 * 7 };
                else standards = { protein: 50 * 7, carbs: 280 * 7, fat: 50 * 7, calories: 1800 * 7 };
            }
            return standards;
        }

        function updateCaloriesChart(totalCalories, targetCalories) {
            const ctx = document.getElementById('caloriesChart').getContext('2d');

            let percentage = (totalCalories / targetCalories) * 100;
            let remainingPercentage = 100 - percentage;

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#8364DF');
            gradient.addColorStop(1, '#C084FC');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [
                        {
                            data: [percentage, remainingPercentage],
                            backgroundColor: [gradient, '#E0E0E0'],
                            borderWidth: 0,
                            cutout: '75%',
                        },
                    ],
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                },
            });

            $(".chart-center-text").html(`<p>${totalCalories} <span style="font-size: 14px; color: #999;">cal</span></p>`);
        }

        function updateImprovementTips(protein, carbs, fat, standards) {
            let tips = [];

            // ë‹¨ë°±ì§ˆ ì„­ì·¨ ë¶„ì„
            if (protein > standards.protein) {
                tips.push("ğŸ’ª <strong>ë‹¨ë°±ì§ˆ ì„­ì·¨ëŸ‰ì´ ì¶©ë¶„í•©ë‹ˆë‹¤.</strong> ìœ ì§€í•˜ì„¸ìš”!");
            } else if (protein < standards.protein * 0.8) {
                tips.push("âš¡ <strong>ë‹¨ë°±ì§ˆ ì„­ì·¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</strong> ë‹­ê°€ìŠ´ì‚´, ë‘ë¶€ ë“± ê³ ë‹¨ë°± ì‹í’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”.");
            }

            // íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ ë¶„ì„
            if (carbs > standards.carbs) {
                tips.push("ğŸ <strong>íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ê°€ ë§ìŠµë‹ˆë‹¤.</strong> ì •ì œ íƒ„ìˆ˜í™”ë¬¼(í°ìŒ€, ë¹µ)ë³´ë‹¤ ë³µí•© íƒ„ìˆ˜í™”ë¬¼(í˜„ë¯¸, ê³ êµ¬ë§ˆ)ì„ ì„ íƒí•˜ì„¸ìš”.");
            } else if (carbs < standards.carbs * 0.8) {
                tips.push("ğŸš <strong>íƒ„ìˆ˜í™”ë¬¼ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.</strong> í˜„ë¯¸ë°¥, ê°ì, ê·€ë¦¬ ë“± ê±´ê°•í•œ íƒ„ìˆ˜í™”ë¬¼ì„ ì¶”ê°€í•˜ì„¸ìš”.");
            }

            // ì§€ë°© ì„­ì·¨ ë¶„ì„
            if (fat > standards.fat) {
                tips.push("ğŸ¥‘ <strong>ì§€ë°© ì„­ì·¨ê°€ ë§ìŠµë‹ˆë‹¤.</strong> íŠ¸ëœìŠ¤ ì§€ë°© ëŒ€ì‹  ê²¬ê³¼ë¥˜, ì˜¬ë¦¬ë¸Œì˜¤ì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
            } else if (fat < standards.fat * 0.8) {
                tips.push("ğŸ³ <strong>ì§€ë°© ì„­ì·¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</strong> ì•„ë³´ì¹´ë„, ì—°ì–´, ë“¤ê¸°ë¦„ ë“±ì„ í†µí•´ ê±´ê°•í•œ ì§€ë°©ì„ ë³´ì¶©í•˜ì„¸ìš”.");
            }

            // HTML ë Œë”ë§ (ì¤„ ê°„ê²© ì ìš©)
            $("#tip-text").html(tips.length > 0
                ? tips.map(tip => `<p style="margin-bottom: 8px;">${tip}</p>`).join("")
                : "<p>âœ… <strong>ì´ë²ˆ ì£¼ ì˜ì–‘ ì„­ì·¨ê°€ ì ì ˆí•©ë‹ˆë‹¤!</strong> ê³„ì† ìœ ì§€í•˜ì„¸ìš”.</p>"
            );
        }

    });
</script>


</body>
</html>