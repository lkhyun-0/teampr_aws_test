<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì‹ë‹¨ ë¶„ì„</title>
    <link rel="stylesheet" href="/css/food/analysis.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div class="container">
    <!-- ìƒë‹¨ íƒ­ -->
    <div class="tabs">
        <a href="/food/foodRecord" class="tab-button">ê¸°ë¡</a>
        <a href="/food/foodList" class="tab-button">ëª©ë¡</a>
        <a href="/food/analysis" class="tab-button active">ë‚´ ì‹ë‹¨ ë¶„ì„</a>
    </div>

    <div class="outer-container">

        <!-- ì£¼ê°„ ë²”ìœ„ í‘œì‹œ -->
        <div class="weekly-range">
            <p id="date-range">ì£¼ê°„ í†µê³„ ë¡œë“œ ì¤‘...</p>
        </div>

        <div class="inner-container">

            <!-- ìƒë‹¨ ì¹´ë“œ ì„¹ì…˜ -->
            <div class="top-section">
                <div class="card">
                    <p class="card-value">
                        <span id="protein-value" class="number">0</span>
                        <span class="unit">g</span>
                    </p>
                    <p class="card-title">ë‹¨ ë°± ì§ˆ</p>
                    <div class="bar">
                        <div class="bar-inner protein"></div>
                    </div>
                </div>
                <div class="card">
                    <p class="card-value">
                        <span id="carbs-value" class="number">0</span>
                        <span class="unit">g</span>
                    </p>
                    <p class="card-title">íƒ„ ìˆ˜ í™” ë¬¼</p>
                    <div class="bar">
                        <div class="bar-inner carbs"></div>
                    </div>
                </div>
                <div class="card">
                    <p class="card-value">
                        <span id="fat-value" class="number">0</span>
                        <span class="unit">g</span>
                    </p>
                    <p class="card-title">ì§€ ë°©</p>
                    <div class="bar">
                        <div class="bar-inner fat"></div>
                    </div>
                </div>
            </div>

            <!-- í•˜ë‹¨ ì¹´ë“œ ì„¹ì…˜ -->
            <div class="bottom-section">
                <div class="card large">
                    <p class="analysis-title">ì´ë²ˆì£¼ ì´ ì¹¼ë¡œë¦¬</p>
                    <canvas id="caloriesChart"></canvas>
                </div>
                <div class="card large">
                    <p class="analysis-title">ê±´ê°•í•œ ì‹ë‹¨ ê°€ì´ë“œ</p>
                    <p id="tip-text">ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script>
    $(document).ready(function () {
        let userPk = [[${session.userPk}]];

        // í˜„ì¬ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìµœê·¼ 7ì¼ ë²”ìœ„ ê³„ì‚°
        let today = new Date();
        let startDate = new Date();
        startDate.setDate(today.getDate() - 6);

        let startStr = `${String(startDate.getMonth() + 1).padStart(2, '0')}ì›” ${String(startDate.getDate()).padStart(2, '0')}ì¼`;
        let endStr = `${String(today.getMonth() + 1).padStart(2, '0')}ì›” ${String(today.getDate()).padStart(2, '0')}ì¼`;

        $("#date-range").text(`${startStr} - ${endStr}` + " ì‹ë‹¨ ë¶„ì„");

        // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì„±ë³„ & ë‚˜ì´)
        $.ajax({
            url: "/food/getUserDetail",
            type: "GET",
            data: { userPk: userPk },
            success: function (user) {
                let gender = user.gender;
                let age = user.age;
                let standards = getNutritionStandards(gender, age);

                // ì£¼ê°„ í†µê³„ ê°€ì ¸ì˜¤ê¸°
                $.ajax({
                    url: "/food/weeklyStats",
                    type: "GET",
                    data: { userPk: userPk },
                    success: function (response) {
                        let totalProtein = 0, totalCarbs = 0, totalFat = 0, totalCalories = 0;

                        response.forEach(day => {
                            totalProtein += day.totalProtein;
                            totalCarbs += day.totalCarbohydrates;
                            totalFat += day.totalFat;
                            totalCalories += day.totalCalories;
                        });

                        $("#protein-value").text(totalProtein.toFixed(2));
                        $("#carbs-value").text(totalCarbs.toFixed(2));
                        $("#fat-value").text(totalFat.toFixed(2));

                        updateCaloriesChart(totalCalories, standards.calories);
                        updateImprovementTips(totalProtein, totalCarbs, totalFat, standards);
                    }
                });
            }
        });


        // 7ì¼ ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜ëœ ì„±ë³„ & ì—°ë ¹ë³„ ì˜ì–‘ì†Œ ê¸°ì¤€
        const nutritionStandards = {
            male: {
                "19-29": { protein: 65 * 7, carbs: [356 * 7, 420 * 7], fat: [49 * 7, 101 * 7], calories: 2600 * 7 },
                "30-49": { protein: 65 * 7, carbs: [350 * 7, 410 * 7], fat: [47 * 7, 97 * 7], calories: 2500 * 7 },
                "50-64": { protein: 60 * 7, carbs: [300 * 7, 354 * 7], fat: [49 * 7, 86 * 7], calories: 2200 * 7 },
                "65-74": { protein: 60 * 7, carbs: [275 * 7, 325 * 7], fat: [44 * 7, 78 * 7], calories: 2000 * 7 }
            },
            female: {
                "19-29": { protein: 55 * 7, carbs: [275 * 7, 325 * 7], fat: [44 * 7, 78 * 7], calories: 2000 * 7 },
                "30-49": { protein: 50 * 7, carbs: [270 * 7, 318 * 7], fat: [42 * 7, 74 * 7], calories: 1900 * 7 },
                "50-64": { protein: 50 * 7, carbs: [255 * 7, 300 * 7], fat: [38 * 7, 66 * 7], calories: 1700 * 7 },
                "65-74": { protein: 50 * 7, carbs: [220 * 7, 260 * 7], fat: [36 * 7, 62 * 7], calories: 1600 * 7 }
            }
        };

        // ì„±ë³„ê³¼ ì—°ë ¹ì„ ê¸°ì¤€ìœ¼ë¡œ ê¶Œì¥ ì„­ì·¨ëŸ‰ ë°˜í™˜
        function getNutritionStandards(gender, age) {
            let category = age <= 29 ? "19-29" : age <= 49 ? "30-49" : age <= 64 ? "50-64" : "65-74";
            return nutritionStandards[gender === "M" ? "male" : "female"][category];
        }



        function updateImprovementTips(protein, carbs, fat, standards) {
            let tips = [];

            // ë‹¨ë°±ì§ˆ ì„­ì·¨ ë¶„ì„
            if (protein > standards.protein) {
                tips.push("ğŸ’ª <strong>ë‹¨ë°±ì§ˆ ì„­ì·¨ëŸ‰ì´ ì¶©ë¶„í•©ë‹ˆë‹¤.</strong> ìœ ì§€í•˜ì„¸ìš”!");
            } else if (protein < standards.protein * 0.8) {
                tips.push("âš¡ <strong>ë‹¨ë°±ì§ˆ ì„­ì·¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</strong> ë‹­ê°€ìŠ´ì‚´, ë‘ë¶€ ë“± ê³ ë‹¨ë°± ì‹í’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”.");
            } else {
                tips.push("âœ”ï¸ <strong>ë‹¨ë°±ì§ˆ ì„­ì·¨ê°€ ì ì ˆí•©ë‹ˆë‹¤.</strong> ê³„ì† ìœ ì§€í•˜ì„¸ìš”!");
            }

            // íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ ë¶„ì„
            if (carbs > standards.carbs[1]) {
                tips.push("ğŸ <strong>íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ê°€ ë§ìŠµë‹ˆë‹¤.</strong> ì •ì œ íƒ„ìˆ˜í™”ë¬¼(í°ìŒ€, ë¹µ)ë³´ë‹¤ ë³µí•© íƒ„ìˆ˜í™”ë¬¼(í˜„ë¯¸, ê³ êµ¬ë§ˆ)ì„ ì„ íƒí•˜ì„¸ìš”.");
            } else if (carbs < standards.carbs[0]) {
                tips.push("ğŸš <strong>íƒ„ìˆ˜í™”ë¬¼ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.</strong> í˜„ë¯¸ë°¥, ê°ì, ê·€ë¦¬ ë“± ê±´ê°•í•œ íƒ„ìˆ˜í™”ë¬¼ì„ ì¶”ê°€í•˜ì„¸ìš”.");
            } else {
                tips.push("âœ”ï¸ <strong>íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ê°€ ì ì ˆí•©ë‹ˆë‹¤.</strong> ê· í˜•ì„ ìœ ì§€í•˜ì„¸ìš”!");
            }

            // ì§€ë°© ì„­ì·¨ ë¶„ì„
            if (fat > standards.fat[1]) {
                tips.push("ğŸ¥‘ <strong>ì§€ë°© ì„­ì·¨ëŸ‰ì´ ë§ìŠµë‹ˆë‹¤.</strong> íŠ¸ëœìŠ¤ ì§€ë°© ëŒ€ì‹  ê²¬ê³¼ë¥˜, ì˜¬ë¦¬ë¸Œì˜¤ì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
            } else if (fat < standards.fat[0]) {
                tips.push("ğŸ³ <strong>ì§€ë°© ì„­ì·¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</strong> ì•„ë³´ì¹´ë„, ì—°ì–´, ë“¤ê¸°ë¦„ ë“±ì„ í†µí•´ ê±´ê°•í•œ ì§€ë°©ì„ ë³´ì¶©í•˜ì„¸ìš”.");
            } else {
                tips.push("âœ”ï¸ <strong>ì§€ë°© ì„­ì·¨ê°€ ì ì ˆí•©ë‹ˆë‹¤.</strong> ê±´ê°•í•œ ìŠµê´€ì„ ìœ ì§€í•˜ì„¸ìš”!");
            }

            // í”¼ë“œë°±ì´ ì—†ì„ ê²½ìš° ê¸°ë³¸ ë©”ì‹œì§€ ì¶”ê°€
            if (tips.length === 0) {
                tips.push("<p> âœ”ï¸ <strong>ì´ë²ˆ ì£¼ ì˜ì–‘ ì„­ì·¨ê°€ ì ì ˆí•©ë‹ˆë‹¤!</strong> ê³„ì† ìœ ì§€í•˜ì„¸ìš”!</p>");
            }

            $("#tip-text").html(tips.map(tip => `<p style="margin-bottom: 8px;">${tip}</p>`).join(""));
        }


        // ì¹¼ë¡œë¦¬ ë„ë„› ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
        function updateCaloriesChart(totalCalories, targetCalories) {
            const ctx = document.getElementById('caloriesChart').getContext('2d');

            let percentage = (totalCalories / targetCalories) * 100;
            let remainingPercentage = 100 - percentage;

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#8364DF');
            gradient.addColorStop(1, '#C084FC');

            // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ ì‚­ì œ
            if (window.caloriesChart && typeof window.caloriesChart.destroy === "function") {
                window.caloriesChart.destroy();
            }

            // ìƒˆë¡œìš´ ì°¨íŠ¸ ìƒì„±
            window.caloriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [
                        {
                            data: [percentage, remainingPercentage],
                            backgroundColor: [gradient, '#E0E0E0'],
                            borderWidth: 0,
                            cutout: '75%',
                        },
                    ],
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                },
            });

            // ê¸°ì¡´ ì¤‘ì•™ í…ìŠ¤íŠ¸ ì‚­ì œ í›„ ë‹¤ì‹œ ì¶”ê°€
            $(".chart-center-text").remove();

            const textContainer = document.createElement('div');
            textContainer.classList.add('chart-center-text');
            textContainer.innerHTML = `<p>${totalCalories.toLocaleString()} <span style="font-size: 14px; color: #999;">cal</span></p>`;

            document.querySelector('#caloriesChart').parentElement.appendChild(textContainer);
        }
    });
</script>

</body>
</html>