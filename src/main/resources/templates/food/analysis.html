<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì‹ë‹¨ ë¶„ì„</title>
    <link rel="stylesheet" href="/css/food/analysis.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div class="container">
    <!-- ìƒë‹¨ íƒ­ -->
    <div class="tabs">
        <a href="/food/foodRecord" class="tab-button">ê¸°ë¡</a>
        <a href="/food/foodList" class="tab-button">ëª©ë¡</a>
        <a href="/food/analysis" class="tab-button active">ë‚´ ì‹ë‹¨ ë¶„ì„</a>
    </div>

    <div class="outer-container">

        <!-- ì£¼ê°„ ë²”ìœ„ í‘œì‹œ -->
        <div class="weekly-range">
            <p id="date-range">ì£¼ê°„ í†µê³„ ë¡œë“œ ì¤‘...</p>
        </div>

        <div class="inner-container">

            <!-- ìƒë‹¨ ì¹´ë“œ ì„¹ì…˜ -->
            <div class="top-section">
                <div class="card">
                    <p class="card-value">
                        <span id="protein-value" class="number">0</span>
                        <span class="unit">g</span>
                    </p>
                    <p class="card-title">PROTEIN</p>
                    <div class="bar">
                        <div class="bar-inner protein"></div>
                    </div>
                </div>
                <div class="card">
                    <p class="card-value">
                        <span id="carbs-value" class="number">0</span>
                        <span class="unit">g</span>
                    </p>
                    <p class="card-title">CARBOHYDRATES</p>
                    <div class="bar">
                        <div class="bar-inner carbs"></div>
                    </div>
                </div>
                <div class="card">
                    <p class="card-value">
                        <span id="fat-value" class="number">0</span>
                        <span class="unit">g</span>
                    </p>
                    <p class="card-title">FAT</p>
                    <div class="bar">
                        <div class="bar-inner fat"></div>
                    </div>
                </div>
            </div>

            <!-- í•˜ë‹¨ ì¹´ë“œ ì„¹ì…˜ -->
            <div class="bottom-section">
                <div class="card large">
                    <p class="analysis-title">ì´ë²ˆì£¼ ì´ ì¹¼ë¡œë¦¬</p>
                    <canvas id="caloriesChart"></canvas>
                </div>
                <div class="card large">
                    <p class="analysis-title">Improvement Tips</p>
                    <p id="tip-text">ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script th:inline="javascript">
    $(document).ready(function () {
        let userPk = [[${session.userPk}]];

        // í˜„ì¬ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìµœê·¼ 7ì¼ ë²”ìœ„ ê³„ì‚°
        let today = new Date();
        let startDate = new Date();
        startDate.setDate(today.getDate() - 6); // 7ì¼ ì „ ë‚ ì§œ ê³„ì‚°

        let startStr = `${String(startDate.getMonth() + 1).padStart(2, '0')}ì›” ${String(startDate.getDate()).padStart(2, '0')}ì¼`;
        let endStr = `${String(today.getMonth() + 1).padStart(2, '0')}ì›” ${String(today.getDate()).padStart(2, '0')}ì¼`;

        $("#date-range").text(`${startStr} - ${endStr}`);

        $.ajax({
            url: "/food/weeklyStats",
            type: "GET",
            data: { userPk: userPk },
            success: function (response) {
                console.log("ì£¼ê°„ í†µê³„ ë°ì´í„°:", response);

                let totalProtein = 0, totalCarbs = 0, totalFat = 0, totalCalories = 0;

                response.forEach(day => {
                    totalProtein += day.totalProtein;
                    totalCarbs += day.totalCarbohydrates;
                    totalFat += day.totalFat;
                    totalCalories += day.totalCalories;
                });

                $("#protein-value").text(totalProtein.toFixed(2));
                $("#carbs-value").text(totalCarbs.toFixed(2));
                $("#fat-value").text(totalFat.toFixed(2));

                updateCaloriesChart(totalCalories);
                updateImprovementTips(totalProtein, totalCarbs, totalFat);
            },
            error: function (xhr, status, error) {
                console.error("ì£¼ê°„ í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
                $("#tip-text").text("ì£¼ê°„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        });

        function updateCaloriesChart(totalCalories) {
            const ctx = document.getElementById('caloriesChart').getContext('2d');

            let targetCalories = 2800 * 7;
            let percentage = (totalCalories / targetCalories) * 100;
            let remainingPercentage = 100 - percentage;

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#8364DF');
            gradient.addColorStop(1, '#C084FC');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [
                        {
                            data: [percentage, remainingPercentage],
                            backgroundColor: [gradient, '#E0E0E0'],
                            borderWidth: 0,
                            cutout: '75%',
                        },
                    ],
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                },
            });

            const textContainer = document.createElement('div');
            textContainer.classList.add('chart-center-text');
            textContainer.innerHTML = `
            <p>${totalCalories} <span style="font-size: 14px; color: #999;">cal</span></p>`;
            document.querySelector('#caloriesChart').parentElement.appendChild(textContainer);
        }

        function updateImprovementTips(protein, carbs, fat) {
            let tip = "";

            if (protein > 400) tip += " ë‹¨ë°±ì§ˆì„ ì ì ˆíˆ ì„­ì·¨ ì¤‘ì…ë‹ˆë‹¤. ì§€ì†í•˜ì„¸ìš”!<br>";
            else if (protein < 200) tip += "âš¡ ë‹¨ë°±ì§ˆ ì„­ì·¨ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë‹­ê°€ìŠ´ì‚´, ë‘ë¶€ ì¶”ì²œ!<br>";

            if (carbs > 500) tip += " íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ëŸ‰ì´ ë§ìŠµë‹ˆë‹¤. ë°¸ëŸ°ìŠ¤ë¥¼ ìœ ì§€í•˜ì„¸ìš”.<br>";
            else if (carbs < 200) tip += "íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ê°€ ì ìŠµë‹ˆë‹¤. í˜„ë¯¸ë°¥, ê°ì ì¶”ê°€í•´ë³´ì„¸ìš”.<br>";

            if (fat > 150) tip += " ì§€ë°© ì„­ì·¨ëŸ‰ì´ ë§ìŠµë‹ˆë‹¤. ì¢‹ì€ ì§€ë°©ì„ ì„ íƒí•˜ì„¸ìš”.<br>";
            else if (fat < 50) tip += "ğŸ³ ê±´ê°•í•œ ì§€ë°©ì„ ì¶©ë¶„íˆ ì„­ì·¨í•˜ì„¸ìš”. ê²¬ê³¼ë¥˜, ì˜¬ë¦¬ë¸Œì˜¤ì¼ ì¶”ì²œ!<br>";

            $("#tip-text").html(tip || " ì´ë²ˆ ì£¼ ì˜ì–‘ ì„­ì·¨ê°€ ì ì ˆí•©ë‹ˆë‹¤! ê³„ì† ìœ ì§€í•˜ì„¸ìš”!");
        }
    });
</script>

</body>
</html>