<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <title>AI ì¶”ì²œ ì‹ë‹¨</title>
    <link rel="stylesheet" href="/css/food/recomResult.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div class="wrapper">
    <h1 id="goal-title">AIê°€ ì¶”ì²œí•˜ëŠ” 3ê°€ì§€ ì‹ë‹¨</h1>

    <!-- íƒ­ -->
    <div class="tabs">
        <div class="tab active" data-tab="tab1">ì‹ë‹¨ 1 ğŸ´</div>
        <div class="tab" data-tab="tab2">ì‹ë‹¨ 2 ğŸ´</div>
        <div class="tab" data-tab="tab3">ì‹ë‹¨ 3 ğŸ´</div>
    </div>

    <!-- ì‹ë‹¨1 í‘œ -->
    <div id="tab1" class="tab-content active">
        <table>
            <thead>
            <tr>
                <th>ë©”ë‰´</th>
                <th>ì˜ì–‘ì •ë³´</th>
            </tr>
            </thead>
            <tbody>
            <!-- ì•„ì¹¨ -->
            <tr>
                <td>ì•„ì¹¨ ì‹ë‹¨ ğŸ˜Š<br><ul id="tab1-breakfast"></ul></td>
                <td><ul id="tab1-breakfast-nutrition"></ul><p id="tab1-breakfast-tip"></p></td>
            </tr>
            <!-- ì ì‹¬ -->
            <tr>
                <td>ì ì‹¬ ì‹ë‹¨ âœ¨<br><ul id="tab1-lunch"></ul></td>
                <td><ul id="tab1-lunch-nutrition"></ul><p id="tab1-lunch-tip"></p></td>
            </tr>
            <!-- ì €ë… -->
            <tr>
                <td>ì €ë… ì‹ë‹¨ ğŸŒ™<br><ul id="tab1-dinner"></ul></td>
                <td><ul id="tab1-dinner-nutrition"></ul><p id="tab1-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ì‹ë‹¨2 í‘œ -->
    <div id="tab2" class="tab-content">
        <table>
            <thead>
            <tr>
                <th>ë©”ë‰´</th>
                <th>ì˜ì–‘ì •ë³´</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>ì•„ì¹¨ ì‹ë‹¨ ğŸ˜Š<br><ul id="tab2-breakfast"></ul></td>
                <td><ul id="tab2-breakfast-nutrition"></ul><p id="tab2-breakfast-tip"></p></td>
            </tr>
            <tr>
                <td>ì ì‹¬ ì‹ë‹¨ âœ¨<br><ul id="tab2-lunch"></ul></td>
                <td><ul id="tab2-lunch-nutrition"></ul><p id="tab2-lunch-tip"></p></td>
            </tr>
            <tr>
                <td>ì €ë… ì‹ë‹¨ ğŸŒ™<br><ul id="tab2-dinner"></ul></td>
                <td><ul id="tab2-dinner-nutrition"></ul><p id="tab2-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ì‹ë‹¨3 í‘œ -->
    <div id="tab3" class="tab-content">
        <table>
            <thead>
            <tr>
                <th>ë©”ë‰´</th>
                <th>ì˜ì–‘ì •ë³´</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>ì•„ì¹¨ ì‹ë‹¨ ğŸ˜Š<br><ul id="tab3-breakfast"></ul></td>
                <td><ul id="tab3-breakfast-nutrition"></ul><p id="tab3-breakfast-tip"></p></td>
            </tr>
            <tr>
                <td>ì ì‹¬ ì‹ë‹¨ âœ¨<br><ul id="tab3-lunch"></ul></td>
                <td><ul id="tab3-lunch-nutrition"></ul><p id="tab3-lunch-tip"></p></td>
            </tr>
            <tr>
                <td>ì €ë… ì‹ë‹¨ ğŸŒ™<br><ul id="tab3-dinner"></ul></td>
                <td><ul id="tab3-dinner-nutrition"></ul><p id="tab3-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ë²„íŠ¼ -->
    <div class="buttons">
        <button class="button" onclick="window.location.href='/food/recom'">ë‹¤ë¥¸ ëª©í‘œ ì„ íƒ</button>
        <button class="button" onclick="window.location.href='/'">ë©”ì¸í™”ë©´</button>
    </div>
</div>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script>
    function parseMealOption(text) {
        const lines = text.split("\n").map(line => line.trim());
        let currentSection = null;

        const data = {
            breakfast: [],
            lunch: [],
            dinner: [],
            tip: []
        };

        for (let line of lines) {
            if (line.startsWith("### ")) {
                continue; // "### ì‹ë‹¨ 1:"ì€ ê±´ë„ˆëœ€
            }
            if (line.startsWith("**ì•„ì¹¨")) {
                currentSection = "breakfast";
                continue;
            } else if (line.startsWith("**ì ì‹¬")) {
                currentSection = "lunch";
                continue;
            } else if (line.startsWith("**ì €ë…")) {
                currentSection = "dinner";
                continue;
            } else if (line.startsWith("**ì˜ì–‘ íŒ")) {
                currentSection = "tip";
                continue;
            }

            if (line.startsWith("-")) {
                const item = line.replace(/^-\s*/, "");
                if (currentSection && data[currentSection]) {
                    data[currentSection].push(item);
                }
            }
        }

        return data;
    }

    // í•˜ë“œì½”ë”©ëœ í‘œì— ë‚´ìš© ì±„ì›Œë„£ê¸°
    function renderDietToHTML(dietData, tabIndex) {
        // ì•„ì¹¨
        const bfUl = $(`#tab${tabIndex}-breakfast`);
        bfUl.empty();
        dietData.breakfast.forEach(item => {
            bfUl.append(`<li>${item}</li>`);
        });

        // ì—¬ê¸°ì„œëŠ” "ì˜ì–‘ì •ë³´" ì˜ì—­ì„ ë³„ë„ë¡œ ì•ˆ ë‚˜ëˆ´ê³ , ì˜ˆì œìƒ tipë§Œ í‘œì‹œ
        // í•„ìš”í•˜ë‹¤ë©´ ì‹í’ˆëª…ê³¼ [g, kcal]ì„ êµ¬ë¶„ íŒŒì‹±í•´ì„œ ì™¼ìª½/ì˜¤ë¥¸ìª½ ì¹¸ì— ë‚˜ëˆŒ ìˆ˜ë„ ìˆìŒ
        const bfTip = $(`#tab${tabIndex}-breakfast-tip`);
        bfTip.text(dietData.tip.join(" "));

        // ì ì‹¬
        const lunchUl = $(`#tab${tabIndex}-lunch`);
        lunchUl.empty();
        dietData.lunch.forEach(item => {
            lunchUl.append(`<li>${item}</li>`);
        });
        const lunchTip = $(`#tab${tabIndex}-lunch-tip`);
        lunchTip.text(dietData.tip.join(" "));

        // ì €ë…
        const dinnerUl = $(`#tab${tabIndex}-dinner`);
        dinnerUl.empty();
        dietData.dinner.forEach(item => {
            dinnerUl.append(`<li>${item}</li>`);
        });
        const dinnerTip = $(`#tab${tabIndex}-dinner-tip`);
        dinnerTip.text(dietData.tip.join(" "));
    }

    $(document).ready(function(){
        const goal = localStorage.getItem("goal");
        if (!goal) {
            alert("ì¶”ì²œë°›ì€ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¶”ì²œì„ ë°›ì•„ì£¼ì„¸ìš”.");
            window.location.href = "/food/recom";
            return;
        }
        $("#goal-title").text(`${goal}ì„(ë¥¼) ìœ„í•œ AI ì¶”ì²œ ì‹ë‹¨`);

        // ì„œë²„ë¡œë¶€í„° ì‹ë‹¨ ì‘ë‹µ
        $.ajax({
            url: "http://localhost:8000/recommend",
            type: "GET",
            data: { goal: goal },
            success: function(response) {
                const mealOptions = response.meal_options;
                // mealOptions[0] = ì‹ë‹¨ 1, mealOptions[1] = ì‹ë‹¨ 2, mealOptions[2] = ì‹ë‹¨ 3
                if (mealOptions && mealOptions.length >= 3) {
                    const diet1 = parseMealOption(mealOptions[0]);
                    renderDietToHTML(diet1, 1);

                    const diet2 = parseMealOption(mealOptions[1]);
                    renderDietToHTML(diet2, 2);

                    const diet3 = parseMealOption(mealOptions[2]);
                    renderDietToHTML(diet3, 3);
                }
            },
            error: function() {
                alert("ì¶”ì²œì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });

        // íƒ­ ì „í™˜
        $(".tab").on("click", function() {
            $(".tab").removeClass("active");
            $(this).addClass("active");

            $(".tab-content").removeClass("active");
            const target = $(this).data("tab");
            $(`#${target}`).addClass("active");
        });
    });
</script>
</body>
</html>
