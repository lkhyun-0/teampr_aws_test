<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <title>AI ì¶”ì²œ ì‹ë‹¨</title>
    <link rel="stylesheet" href="/css/food/recomResult.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div id="loading" style="display: none;">
    <svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
        <circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
    </svg>
    <p>AIê°€ ì‹ë‹¨ì„ ì¶”ì²œ ì¤‘ì…ë‹ˆë‹¤...</p>
</div>



<div class="wrapper">
    <h1 id="goal-title">AIê°€ ì¶”ì²œí•˜ëŠ” 3ê°€ì§€ ì‹ë‹¨</h1>

    <!-- íƒ­ (2, 3ì€ ì²˜ìŒì— ìˆ¨ê¹€) -->
    <div class="tabs">
        <div class="tab active" data-tab="tab1">ì‹ë‹¨ 1 ğŸ´</div>
        <div class="tab" data-tab="tab2" style="display: none;">ì‹ë‹¨ 2 ğŸ´</div>
        <div class="tab" data-tab="tab3" style="display: none;">ì‹ë‹¨ 3 ğŸ´</div>
    </div>

    <!-- ì‹ë‹¨1 í‘œ -->
    <div id="tab1" class="tab-content active">
        <table>
            <thead>
            <tr>
                <th>ë©”ë‰´</th>
                <th>ì˜ì–‘ì •ë³´</th>
            </tr>
            </thead>
            <tbody>
            <!-- ì•„ì¹¨ -->
            <tr>
                <td>ì•„ì¹¨ ì‹ë‹¨ ğŸ˜Š<br><ul id="tab1-breakfast"></ul></td>
                <td><ul id="tab1-breakfast-nutrition"></ul><p id="tab1-breakfast-tip"></p></td>
            </tr>
            <!-- ì ì‹¬ -->
            <tr>
                <td>ì ì‹¬ ì‹ë‹¨ âœ¨<br><ul id="tab1-lunch"></ul></td>
                <td><ul id="tab1-lunch-nutrition"></ul><p id="tab1-lunch-tip"></p></td>
            </tr>
            <!-- ì €ë… -->
            <tr>
                <td>ì €ë… ì‹ë‹¨ ğŸŒ™<br><ul id="tab1-dinner"></ul></td>
                <td><ul id="tab1-dinner-nutrition"></ul><p id="tab1-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ì‹ë‹¨2 í‘œ -->
    <div id="tab2" class="tab-content">
        <table>
            <thead>
            <tr>
                <th>ë©”ë‰´</th>
                <th>ì˜ì–‘ì •ë³´</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>ì•„ì¹¨ ì‹ë‹¨ ğŸ˜Š<br><ul id="tab2-breakfast"></ul></td>
                <td><ul id="tab2-breakfast-nutrition"></ul><p id="tab2-breakfast-tip"></p></td>
            </tr>
            <tr>
                <td>ì ì‹¬ ì‹ë‹¨ âœ¨<br><ul id="tab2-lunch"></ul></td>
                <td><ul id="tab2-lunch-nutrition"></ul><p id="tab2-lunch-tip"></p></td>
            </tr>
            <tr>
                <td>ì €ë… ì‹ë‹¨ ğŸŒ™<br><ul id="tab2-dinner"></ul></td>
                <td><ul id="tab2-dinner-nutrition"></ul><p id="tab2-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ì‹ë‹¨3 í‘œ -->
    <div id="tab3" class="tab-content">
        <table>
            <thead>
            <tr>
                <th>ë©”ë‰´</th>
                <th>ì˜ì–‘ì •ë³´</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>ì•„ì¹¨ ì‹ë‹¨ ğŸ˜Š<br><ul id="tab3-breakfast"></ul></td>
                <td><ul id="tab3-breakfast-nutrition"></ul><p id="tab3-breakfast-tip"></p></td>
            </tr>
            <tr>
                <td>ì ì‹¬ ì‹ë‹¨ âœ¨<br><ul id="tab3-lunch"></ul></td>
                <td><ul id="tab3-lunch-nutrition"></ul><p id="tab3-lunch-tip"></p></td>
            </tr>
            <tr>
                <td>ì €ë… ì‹ë‹¨ ğŸŒ™<br><ul id="tab3-dinner"></ul></td>
                <td><ul id="tab3-dinner-nutrition"></ul><p id="tab3-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ë²„íŠ¼ -->
    <div class="buttons">
        <button class="button" onclick="window.location.href='/food/recom'">ë‹¤ë¥¸ ëª©í‘œ ì„ íƒ</button>
        <button class="button" onclick="window.location.href='/user/mainPage'">ë©”ì¸í™”ë©´</button>
        <button class="button" id="add-diet">ì‹ë‹¨ ì¶”ê°€</button>
    </div>
</div>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script>
    // ì‹ë‹¨ í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜
    function parseMealOption(text) {
        const lines = text.split("\n").map(line => line.trim());
        let currentSection = null;

        const data = {
            breakfast: [],
            breakfastNutrition: [],
            breakfastTip: [],
            lunch: [],
            lunchNutrition: [],
            lunchTip: [],
            dinner: [],
            dinnerNutrition: [],
            dinnerTip: []
        };

        for (let line of lines) {
            // "### ì‹ë‹¨ 1:" ë“±ì˜ í—¤ë”ëŠ” ê±´ë„ˆë›°ê¸°
            if (line.startsWith("### ")) {
                continue;
            }
            if (line.startsWith("**ì•„ì¹¨**")) {
                currentSection = "breakfast";
                continue;
            } else if (line.startsWith("**ì•„ì¹¨ ì˜ì–‘ ì •ë³´**")) {
                currentSection = "breakfastNutrition";
                continue;
            } else if (line.startsWith("**ì•„ì¹¨ ì˜ì–‘ íŒ**")) {
                currentSection = "breakfastTip";
                continue;
            } else if (line.startsWith("**ì ì‹¬**")) {
                currentSection = "lunch";
                continue;
            } else if (line.startsWith("**ì ì‹¬ ì˜ì–‘ ì •ë³´**")) {
                currentSection = "lunchNutrition";
                continue;
            } else if (line.startsWith("**ì ì‹¬ ì˜ì–‘ íŒ**")) {
                currentSection = "lunchTip";
                continue;
            } else if (line.startsWith("**ì €ë…**")) {
                currentSection = "dinner";
                continue;
            } else if (line.startsWith("**ì €ë… ì˜ì–‘ ì •ë³´**")) {
                currentSection = "dinnerNutrition";
                continue;
            } else if (line.startsWith("**ì €ë… ì˜ì–‘ íŒ**")) {
                currentSection = "dinnerTip";
                continue;
            }

            if (line.startsWith("-")) {
                const item = line.replace(/^-\s*/, "");
                if (currentSection && data[currentSection]) {
                    data[currentSection].push(item);
                }
            }
        }
        return data;
    }

    // íŒŒì‹±ëœ ë°ì´í„°ë¥¼ HTMLì˜ í•´ë‹¹ ìœ„ì¹˜ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
    function renderDietToHTML(dietData, tabIndex) {
        // ì•„ì¹¨
        $(`#tab${tabIndex}-breakfast`).empty().append(
            dietData.breakfast.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-breakfast-nutrition`).empty().append(
            dietData.breakfastNutrition.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-breakfast-tip`).text(dietData.breakfastTip.join(" "));

        // ì ì‹¬
        $(`#tab${tabIndex}-lunch`).empty().append(
            dietData.lunch.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-lunch-nutrition`).empty().append(
            dietData.lunchNutrition.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-lunch-tip`).text(dietData.lunchTip.join(" "));

        // ì €ë…
        $(`#tab${tabIndex}-dinner`).empty().append(
            dietData.dinner.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-dinner-nutrition`).empty().append(
            dietData.dinnerNutrition.map(item => `<li>${item}</li>`)
        );
        $(`#tab${tabIndex}-dinner-tip`).text(dietData.dinnerTip.join(" "));
    }

    // íƒ­ í™œì„±í™” í•¨ìˆ˜
    function activateTab(tabId) {
        $(".tab").removeClass("active");
        $(".tab-content").removeClass("active").hide();
        $(`.tab[data-tab="${tabId}"]`).addClass("active");
        $(`#${tabId}`).addClass("active").show();
    }

    // AJAX ìš”ì²­ìœ¼ë¡œ ìƒˆë¡œìš´ ì‹ë‹¨ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function fetchNewDiet(tabIndex) {
        const goal = localStorage.getItem("goal");
        if (!goal) {
            alert("ì¶”ì²œë°›ì€ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¶”ì²œì„ ë°›ì•„ì£¼ì„¸ìš”.");
            window.location.href = "/food/recom";
            return;
        }
        $("#loading").show();
        $.ajax({
            url: "http://localhost:8000/recommend",
            type: "GET",
            data: { goal: goal },
            success: function(response) {
                $("#loading").hide();
                const mealOption = response.meal_options;
                if (mealOption) {
                    const dietData = parseMealOption(mealOption);
                    renderDietToHTML(dietData, tabIndex);
                    // ìƒˆ íƒ­ í™œì„±í™”
                    activateTab("tab" + tabIndex);
                } else {
                    alert("ì¶”ì²œëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            },
            error: function() {
                $("#loading").hide();
                alert("ì¶”ì²œì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    $(document).ready(function(){
        $("#loading").show();

        const goal = localStorage.getItem("goal");
        if (!goal) {
            alert("ì¶”ì²œë°›ì€ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¶”ì²œì„ ë°›ì•„ì£¼ì„¸ìš”.");
            window.location.href = "/food/recom";
            return;
        }
        $("#goal-title").text(`${goal}ë¥¼ ìœ„í•œ AI ì¶”ì²œ ì‹ë‹¨`);

        // ì´ˆê¸° ì‹ë‹¨(ì‹ë‹¨1) ìš”ì²­ ë° ë Œë”ë§
        $.ajax({
            url: "http://localhost:8000/recommend",
            type: "GET",
            data: { goal: goal },
            success: function(response) {
                $("#loading").hide();
                const mealOption = response.meal_options;
                if (mealOption) {
                    const dietData = parseMealOption(mealOption);
                    renderDietToHTML(dietData, 1);
                    activateTab("tab1");
                } else {
                    alert("ì¶”ì²œëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            },
            error: function() {
                $("#loading").hide();
                alert("ì¶”ì²œì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });

        // íƒ­ í´ë¦­ ì´ë²¤íŠ¸ (ê° íƒ­ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ íƒ­ ë‚´ìš©ì´ ë³´ì´ë„ë¡)
        $(".tab").click(function(){
            const tabId = $(this).attr("data-tab");
            activateTab(tabId);
        });

        // 'ì‹ë‹¨ ì¶”ê°€' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        $("#add-diet").click(function(){
            if(confirm("ì‹ë‹¨ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                let nextTabIndex;
                if ($("#tab2").is(":hidden")) {
                    nextTabIndex = 2;
                    $(`.tab[data-tab="tab2"]`).show();
                } else if ($("#tab3").is(":hidden")) {
                    nextTabIndex = 3;
                    $(`.tab[data-tab="tab3"]`).show();
                } else {
                    alert("ë” ì´ìƒ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                fetchNewDiet(nextTabIndex);
            }
        });
    });
</script>

</body>
</html>
