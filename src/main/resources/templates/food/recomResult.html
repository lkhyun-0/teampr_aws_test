<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <title>AI μ¶”μ² μ‹λ‹¨</title>
    <link rel="stylesheet" href="/css/food/recomResult.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div id="loading" style="display: none;">
    <svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
        <circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
    </svg>
    <p>AIκ°€ μ‹λ‹¨μ„ μ¶”μ² μ¤‘μ…λ‹λ‹¤...</p>
</div>



<div class="wrapper">
    <h1 id="goal-title">AIκ°€ μ¶”μ²ν•λ” 3κ°€μ§€ μ‹λ‹¨</h1>

    <!-- νƒ­ -->
    <div class="tabs">
        <div class="tab" data-tab="tab1">μ‹λ‹¨ 1 π΄</div>
    </div>

    <!-- μ‹λ‹¨1 ν‘ -->
    <div id="tab1 active" class="tab-content active">
        <table>
            <thead>
            <tr>
                <th>λ©”λ‰΄</th>
                <th>μμ–‘μ •λ³΄</th>
            </tr>
            </thead>
            <tbody>
            <!-- μ•„μΉ¨ -->
            <tr>
                <td>μ•„μΉ¨ μ‹λ‹¨ π<br><ul id="tab1-breakfast"></ul></td>
                <td><ul id="tab1-breakfast-nutrition"></ul><p id="tab1-breakfast-tip"></p></td>
            </tr>
            <!-- μ μ‹¬ -->
            <tr>
                <td>μ μ‹¬ μ‹λ‹¨ β¨<br><ul id="tab1-lunch"></ul></td>
                <td><ul id="tab1-lunch-nutrition"></ul><p id="tab1-lunch-tip"></p></td>
            </tr>
            <!-- μ €λ… -->
            <tr>
                <td>μ €λ… μ‹λ‹¨ π™<br><ul id="tab1-dinner"></ul></td>
                <td><ul id="tab1-dinner-nutrition"></ul><p id="tab1-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- μ‹λ‹¨2 ν‘ -->
    <div id="tab2" class="tab-content">
        <table>
            <thead>
            <tr>
                <th>λ©”λ‰΄</th>
                <th>μμ–‘μ •λ³΄</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>μ•„μΉ¨ μ‹λ‹¨ π<br><ul id="tab2-breakfast"></ul></td>
                <td><ul id="tab2-breakfast-nutrition"></ul><p id="tab2-breakfast-tip"></p></td>
            </tr>
            <tr>
                <td>μ μ‹¬ μ‹λ‹¨ β¨<br><ul id="tab2-lunch"></ul></td>
                <td><ul id="tab2-lunch-nutrition"></ul><p id="tab2-lunch-tip"></p></td>
            </tr>
            <tr>
                <td>μ €λ… μ‹λ‹¨ π™<br><ul id="tab2-dinner"></ul></td>
                <td><ul id="tab2-dinner-nutrition"></ul><p id="tab2-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- μ‹λ‹¨3 ν‘ -->
    <div id="tab3" class="tab-content">
        <table>
            <thead>
            <tr>
                <th>λ©”λ‰΄</th>
                <th>μμ–‘μ •λ³΄</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>μ•„μΉ¨ μ‹λ‹¨ π<br><ul id="tab3-breakfast"></ul></td>
                <td><ul id="tab3-breakfast-nutrition"></ul><p id="tab3-breakfast-tip"></p></td>
            </tr>
            <tr>
                <td>μ μ‹¬ μ‹λ‹¨ β¨<br><ul id="tab3-lunch"></ul></td>
                <td><ul id="tab3-lunch-nutrition"></ul><p id="tab3-lunch-tip"></p></td>
            </tr>
            <tr>
                <td>μ €λ… μ‹λ‹¨ π™<br><ul id="tab3-dinner"></ul></td>
                <td><ul id="tab3-dinner-nutrition"></ul><p id="tab3-dinner-tip"></p></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- λ²„νΌ -->
    <div class="buttons">
        <button class="button" onclick="window.location.href='/food/recom'">λ‹¤λ¥Έ λ©ν‘ μ„ νƒ</button>
        <button class="button" onclick="window.location.href='/user/mainPage'">λ©”μΈν™”λ©΄</button>
    </div>
</div>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script>
    // μ‹λ‹¨ ν…μ¤νΈλ¥Ό νμ‹±ν•΄μ„ κ° λΌλ‹λ³„ λ°μ΄ν„°λ¥Ό μ¶”μ¶ν•λ” ν•¨μ
    function parseMealOption(text) {
        const lines = text.split("\n").map(line => line.trim());
        let currentSection = null;

        const data = {
            breakfast: [],
            breakfastNutrition: [],
            breakfastTip: [],
            lunch: [],
            lunchNutrition: [],
            lunchTip: [],
            dinner: [],
            dinnerNutrition: [],
            dinnerTip: []
        };

        for (let line of lines) {
            // "### μ‹λ‹¨ 1:" κ°™μ€ ν—¤λ”λ” κ±΄λ„λλ‹λ‹¤.
            if (line.startsWith("### ")) {
                continue;
            }
            if (line.startsWith("**μ•„μΉ¨**")) {
                currentSection = "breakfast";
                continue;
            } else if (line.startsWith("**μ•„μΉ¨ μμ–‘ μ •λ³΄**")) {
                currentSection = "breakfastNutrition";
                continue;
            } else if (line.startsWith("**μ•„μΉ¨ μμ–‘ ν**")) {
                currentSection = "breakfastTip";
                continue;
            } else if (line.startsWith("**μ μ‹¬**")) {
                currentSection = "lunch";
                continue;
            } else if (line.startsWith("**μ μ‹¬ μμ–‘ μ •λ³΄**")) {
                currentSection = "lunchNutrition";
                continue;
            } else if (line.startsWith("**μ μ‹¬ μμ–‘ ν**")) {
                currentSection = "lunchTip";
                continue;
            } else if (line.startsWith("**μ €λ…**")) {
                currentSection = "dinner";
                continue;
            } else if (line.startsWith("**μ €λ… μμ–‘ μ •λ³΄**")) {
                currentSection = "dinnerNutrition";
                continue;
            } else if (line.startsWith("**μ €λ… μμ–‘ ν**")) {
                currentSection = "dinnerTip";
                continue;
            }

            if (line.startsWith("-")) {
                const item = line.replace(/^-\s*/, "");
                if (currentSection && data[currentSection]) {
                    data[currentSection].push(item);
                }
            }
        }
        return data;
    }

    // νμ‹±λ λ°μ΄ν„°λ¥Ό HTMLμ ν•΄λ‹Ή μ„μΉμ— λ λ”λ§ν•λ” ν•¨μ
    function renderDietToHTML(dietData, tabIndex) {
        // μ•„μΉ¨
        $(`#tab${tabIndex}-breakfast`).empty().append(dietData.breakfast.map(item => `<li>${item}</li>`));
        $(`#tab${tabIndex}-breakfast-nutrition`).empty().append(dietData.breakfastNutrition.map(item => `<li>${item}</li>`));
        $(`#tab${tabIndex}-breakfast-tip`).text(dietData.breakfastTip.join(" "));

        // μ μ‹¬
        $(`#tab${tabIndex}-lunch`).empty().append(dietData.lunch.map(item => `<li>${item}</li>`));
        $(`#tab${tabIndex}-lunch-nutrition`).empty().append(dietData.lunchNutrition.map(item => `<li>${item}</li>`));
        $(`#tab${tabIndex}-lunch-tip`).text(dietData.lunchTip.join(" "));

        // μ €λ…
        $(`#tab${tabIndex}-dinner`).empty().append(dietData.dinner.map(item => `<li>${item}</li>`));
        $(`#tab${tabIndex}-dinner-nutrition`).empty().append(dietData.dinnerNutrition.map(item => `<li>${item}</li>`));
        $(`#tab${tabIndex}-dinner-tip`).text(dietData.dinnerTip.join(" "));
    }

    $(document).ready(function(){
        $("#loading").show();  // λ΅λ”© μ‹μ‘

        const goal = localStorage.getItem("goal");
        if (!goal) {
            alert("μ¶”μ²λ°›μ€ μ‹λ‹¨μ΄ μ—†μµλ‹λ‹¤. λ‹¤μ‹ μ¶”μ²μ„ λ°›μ•„μ£Όμ„Έμ”.");
            window.location.href = "/food/recom";
            return;
        }
        $("#goal-title").text(`${goal}λ¥Ό μ„ν• AI μ¶”μ² μ‹λ‹¨`);

        // μ„λ²„λ΅λ¶€ν„° μ‹λ‹¨ μ‘λ‹µ (μ΄μ  λ‹¨μΌ μ‹λ‹¨μ΄ λ°ν™λ©λ‹λ‹¤.)
        $.ajax({
            url: "http://localhost:8000/recommend",
            type: "GET",
            data: { goal: goal },
            success: function(response) {
                $("#loading").hide();  // λ΅λ”© μ¨κΉ€

                // μ΄μ „μ—λ” meal_option(λ³µμ μ‹λ‹¨)μ„ λ°›μ•μ—λ”λ°, μ΄μ  meal_options(λ‹¨μΌ μ‹λ‹¨)μ„ λ°›μµλ‹λ‹¤.
                const mealOption = response.meal_options;

                if (mealOption) {
                    const dietData = parseMealOption(mealOption);
                    renderDietToHTML(dietData, 1);
                } else {
                    alert("μ¶”μ²λ μ‹λ‹¨μ΄ μ—†μµλ‹λ‹¤.");
                }
            },
            error: function() {
                alert("μ¶”μ²μ„ κ°€μ Έμ¤λ” λ° μ‹¤ν¨ν–μµλ‹λ‹¤.");
            }
        });
    });
</script>

</body>
</html>
