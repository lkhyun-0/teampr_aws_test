<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì¶”ì²œ ì‹ë‹¨</title>
    <link rel="stylesheet" href="/css/food/foodResult.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>

<!--header-->
<div th:insert="~{/common/header.html}"></div>

<div class="wrapper">
    <h1 id="goal-title">AIê°€ ì¶”ì²œí•˜ëŠ” 3ê°€ì§€ ì‹ë‹¨</h1>

    <div class="tabs">
        <button class="tab active" data-tab="tab1">ì‹ë‹¨ 1 ğŸ´</button>
        <button class="tab" data-tab="tab2">ì‹ë‹¨ 2 ğŸ´</button>
        <button class="tab" data-tab="tab3">ì‹ë‹¨ 3 ğŸ´</button>
    </div>

    <div class="meal-container">
        <div id="tab1" class="tab-content active"></div>
        <div id="tab2" class="tab-content"></div>
        <div id="tab3" class="tab-content"></div>
    </div>

    <div class="buttons">
        <button class="button" onclick="window.location.href='/food/recom'">ë‹¤ë¥¸ ëª©í‘œ ì„ íƒ</button>
        <button class="button" onclick="window.location.href='/'">ë©”ì¸í™”ë©´</button>
    </div>
</div>

<!--footer-->
<div th:insert="~{/common/footer.html}"></div>

<script>
    $(document).ready(function () {
        const goal = localStorage.getItem("goal");
        if (!goal) {
            alert("ì¶”ì²œë°›ì€ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¶”ì²œì„ ë°›ì•„ì£¼ì„¸ìš”.");
            window.location.href = "/food/recom";
            return;
        }

        $.ajax({
            url: "http://localhost:8000/recommend",
            type: "GET",
            data: { goal: goal },
            success: function (response) {
                $("#goal-title").text(`${goal}ì„ ìœ„í•œ AI ì¶”ì²œ ì‹ë‹¨`);
                const mealOptions = response.meal_options;
                if (mealOptions.length >= 3) {
                    $("#tab1").html(generateMealCard(mealOptions[0]));
                    $("#tab2").html(generateMealCard(mealOptions[1]));
                    $("#tab3").html(generateMealCard(mealOptions[2]));
                }
            },
            error: function () {
                alert("ì¶”ì²œì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });

        $('.tab').on('click', function () {
            $('.tab').removeClass('active');
            $(this).addClass('active');
            $('.tab-content').removeClass('active');
            $('#' + $(this).data('tab')).addClass('active');
        });
    });

    function generateMealCard(mealText) {
        if (!mealText || mealText.trim() === "") {
            return "<div class='meal-card'><p>ì¶”ì²œëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>";
        }

        const mealLines = mealText.split("\n");
        let html = "<div class='meal-card'>";
        let currentMeal = "";
        let mealContent = "";

        mealLines.forEach(line => {
            line = line.trim();

            if (line.startsWith("**") && line.endsWith("**")) {
                if (currentMeal !== "") {
                    html += `<div class='meal-section'>
                                <h3>${currentMeal}</h3>
                                <p>${mealContent}</p>
                             </div>`;
                    mealContent = "";
                }
                currentMeal = line.replace(/\*\*/g, "");
            } else if (line.startsWith("-")) {
                const parts = line.replace("-", "").split("-");
                mealContent += `<strong>${parts[0].trim()}</strong>: ${parts[1] ? parts[1].trim() : ""}<br>`;
            } else if (line.startsWith("ì˜ì–‘ íŒ:")) {
                html += `<div class='nutrition-tip'><em>${line}</em></div>`;
            }
        });

        if (currentMeal !== "") {
            html += `<div class='meal-section'>
                        <h3>${currentMeal}</h3>
                        <p>${mealContent}</p>
                     </div>`;
        }

        html += "</div>";
        return html;
    }
</script>
</body>
</html>